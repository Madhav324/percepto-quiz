<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Cognition - Object Finding</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        #quiz-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        #quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            font-weight: 600;
            margin: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.3s;
            font-size: 16px;
        }
        
        .profile-icon:hover {
            background-color: #1976D2;
        }

        .profile-icon:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            right: 0;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-top: 5px;
        }

        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #45a049, #4CAF50);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #1976D2, #2196F3);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        #question-container {
            margin-bottom: 20px;
            position: relative;
        }

        #question-container img {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: contain;
        }

        .scenario-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            overflow: hidden;
            border: 4px solid #e0e0e0;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 800px;
        }

        .instruction-text {
            font-size: 1.3rem;
            color: #2c3e50;
            margin: 25px auto;
            font-weight: 600;
            text-align: center;
            max-width: 800px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px solid #dee2e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        /* Responsive Media Queries */
        @media (max-width: 500px) {
            #quiz-container {
                padding: 15px;
                width: 100%;
                max-width: 100%;
            }
            
            .scenario-container {
                max-width: 100%;
                margin: 15px auto;
                padding: 10px;
            }
            
            .scenario-image {
                max-width: 100%;
                border-radius: 8px;
            }
            
            .profile-icon {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .target-object {
                width: 35px;
                height: 35px;
                padding: 2px;
            }
            
            .instruction-text {
                font-size: 1.1rem;
                margin: 15px auto;
                padding: 12px;
            }
            
            .target-objects-container {
                margin: 15px auto;
                max-width: 100%;
            }
            
            button {
                padding: 5px 10px;
                margin: 5px;
                font-size: 14px;
                min-height: 26px;
            }
        }

        .scenario-image {
            width: 100%;
            max-width: 1200px;
            height: auto;
            min-height: 750px;
            display: block;
            margin: 0 auto;
            border-radius: 16px;
            object-fit: contain;
            cursor: crosshair;
        }

        .clickable-area {
            position: absolute;
            background-color: transparent;
            cursor: pointer;
            z-index: 2;
        }

        .clickable-area:hover {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .clickable-area.selected {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.3);
        }
        
        .scenario-object {
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .scenario-object:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }

        .feedback-mark {
            position: absolute;
            font-size: 24px;
            z-index: 3;
        }
        
        /* Object Finding Puzzle Styles */
        .target-objects-container {
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        
        #target-objects {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            justify-content: center;
            background-color: rgba(245, 245, 250, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .target-objects-title {
            font-size: 1.0rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .target-object {
            width: 50px;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 4px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .target-object:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: #4CAF50;
        }
        
        .target-object img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #scenario-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 5px auto;
            border: 2px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        #scenario-image {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .clickable-area {
            position: absolute;
            cursor: pointer;
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            z-index: 5;
            transition: background-color 0.2s;
        }
        
        .clickable-area:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .success-mark, .fail-mark {
            animation: fadeInOut 1s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        .target-objects {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .target-object {
            width: 60px;
            height: 60px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 5px;
            object-fit: contain;
            background-color: #e3f2fd;
        }

        @media (max-width: 480px) {
            .target-object {
                width: 45px;
                height: 45px;
                padding: 3px;
            }
        }

        #images-container img:hover {
            border-color: #4CAF50;
        }

        #result-container {
            display: none;
            margin-top: 20px;
        }

        #report-container {
            margin-top: 40px;
            width: 80%;
            max-width: 600px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #report-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #report-container ul {
            list-style-type: none;
            padding: 0;
        }

        #report-container li {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        h1, h2 {
            color: #2c3e50;
            margin: 0;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            font-size: 14px;
            color: #666;
        }
        
        .patient-indicator {
            display: inline-block;
            background-color: #e9f5e9;
            color: #4CAF50;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .attempt-item {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .attempt-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .attempt-date {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }
        
        .attempt-score {
            color: #4CAF50;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .attempt-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            color: #333;
            font-size: 14px;
        }
        
        .attempt-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .detail-label {
            font-weight: bold;
            color: #555;
        }
        
        .toggle-details-btn {
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .toggle-details-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="quiz-container">
        <div class="header">
            <h1>Visual Object Finding</h1>
            <div class="profile-icon" id="profileIcon" title="Back to Home" onclick="window.location.href='index.html'">üè†</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        
        <div id="quiz-content">
            <div class="patient-test-banner" id="patientTestBanner" style="display: none">
                <span id="patientName"></span>
                <div class="patient-indicator">Patient Test</div>
            </div>
            
            <!-- Object Selection Task -->
            <div id="question-container" style="display: none;">
                <div class="instruction-text" id="instructionText">Find and click on these objects in the scene below:</div>
                
                <div id="sequenceStatus" style="display: none; margin: 15px 0; padding: 10px; background: #e3f2fd; border-radius: 8px; font-weight: 600;"></div>
                
                <div class="scenario-container" id="scenario-container">
                    <img id="scenario-image" class="scenario-image" alt="Scenario">
                    <!-- Objects will be added here dynamically -->
                </div>
                
                <div class="target-objects-container">
                    <div class="target-objects-title">Target Objects to Find</div>
                    <div id="target-objects"></div>
                </div>
                
                <div class="game-controls">
                    <button class="btn-secondary" onclick="skipQuestion()">Skip Question</button>
                    <button onclick="window.location.href='VC.html'">Return to Menu</button>
                </div>
            </div>
            
            <div id="images-container" class="option-container" style="display: none;"></div>
            
            <div id="result-container" style="display:none">
                <div class="result-message">Quiz Complete!</div>
                <h2>Quiz Results</h2>
                <ul style="list-style: none; padding: 0;">
                    <li><strong>Score:</strong> <span id="score"></span></li>
                    <li><strong>Total Time:</strong> <span id="total-time"></span> seconds</li>
                    <li><strong>Average Time:</strong> <span id="avg-time"></span> seconds</li>
                    <li><strong>First Tap Time:</strong> <span id="first-tap"></span> seconds</li>
                    <li><strong>Total Taps:</strong> <span id="total-taps"></span></li>
                    <li><strong>Total Correct Answers:</strong> <span id="total-correct"></span></li>
                    <li><strong>Total Incorrect Answers:</strong> <span id="total-incorrect"></span></li>
                </ul>
                <div class="button-container" style="margin-top: 10px;">
                    <button onclick="restartQuiz()" style="margin-right: 10px; min-height: 26px; padding: 5px 10px; font-size: 0.9rem;">Restart Quiz</button>
                    <button onclick="window.location.href='VC.html'" style="min-height: 26px; padding: 5px 10px; font-size: 0.9rem;">Return to Visual Cognition</button>
                </div>
            </div>
        </div>
    </div>

    <div id="report-container" style="display: none;">
        <div id="report-list"></div>
        <button id="clear-report" onclick="clearReport()">Clear Report</button>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFENL5Z_2Cewh4p6zp_BZtxL9n0di-9u8",
            authDomain: "projeccvi.firebaseapp.com",
            projectId: "projeccvi",
            storageBucket: "projeccvi.appspot.com",
            messagingSenderId: "279067566247",
            appId: "1:279067566247:web:9cf00f7bf1ea3549fabb82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Quiz context handling
        const currentPatientId = sessionStorage.getItem('currentPatientId');
        const doctorId = sessionStorage.getItem('doctorId');
        const isPatientQuiz = !!(currentPatientId && doctorId);
        
        console.log('Quiz context:', {
            isPatientQuiz, 
            currentPatientId: currentPatientId || 'none',
            doctorId: doctorId || 'none'
        });

        const scenarios = [
            {
                // Kitchen Scene - Find cooking utensils in a busy kitchen
                scenarioImage: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='750' viewBox='0 0 1200 750'><defs><linearGradient id='counterGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%23e8e8e8'/><stop offset='100%25' style='stop-color:%23d0d0d0'/></linearGradient><linearGradient id='cabinetGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%238B4513'/><stop offset='100%25' style='stop-color:%23654321'/></linearGradient></defs><rect width='1200' height='750' fill='%23f5f5dc'/><rect x='0' y='480' width='1200' height='270' fill='url(%23counterGrad)' stroke='%23999' stroke-width='3'/><rect x='90' y='90' width='225' height='390' fill='url(%23cabinetGrad)' stroke='%23333' stroke-width='3'/><rect x='375' y='90' width='225' height='390' fill='url(%23cabinetGrad)' stroke='%23333' stroke-width='3'/><rect x='660' y='90' width='225' height='390' fill='url(%23cabinetGrad)' stroke='%23333' stroke-width='3'/><circle cx='202' cy='285' r='15' fill='%23FFD700'/><circle cx='487' cy='285' r='15' fill='%23FFD700'/><circle cx='772' cy='285' r='15' fill='%23FFD700'/><rect x='930' y='150' width='150' height='225' fill='%23C0C0C0' stroke='%23999' stroke-width='3'/><rect x='945' y='165' width='120' height='195' fill='%23000'/><rect x='990' y='120' width='18' height='52' fill='%23333'/><ellipse cx='195' cy='540' rx='45' ry='27' fill='%23FF6347' stroke='%23333' stroke-width='3'/><rect x='195' y='517' width='18' height='15' fill='%23228B22'/><rect x='285' y='517' width='75' height='37' fill='%23228B22' stroke='%23333' stroke-width='2'/><ellipse cx='480' cy='555' rx='52' ry='37' fill='%23FFD700' stroke='%23333' stroke-width='3'/><rect x='630' y='532' width='60' height='27' fill='%238B4513' stroke='%23333' stroke-width='2'/><ellipse cx='810' cy='547' rx='37' ry='22' fill='%23FF69B4' stroke='%23333' stroke-width='3'/><rect x='930' y='525' width='45' height='45' fill='%23C0C0C0' stroke='%23333' stroke-width='3'/><line x1='937' y1='532' x2='967' y2='562' stroke='%23333' stroke-width='6'/><line x1='967' y1='532' x2='937' y2='562' stroke='%23333' stroke-width='6'/><rect x='1020' y='532' width='52' height='15' fill='%23654321' stroke='%23333' stroke-width='2'/><circle cx='1046' cy='540' r='6' fill='%23333'/><ellipse cx='150' cy='630' rx='27' ry='15' fill='%234169E1' stroke='%23333' stroke-width='2'/><rect x='225' y='615' width='37' height='18' fill='%23FF4500' stroke='%23333' stroke-width='2'/><ellipse cx='345' cy='637' rx='33' ry='18' fill='%23ADFF2F' stroke='%23333' stroke-width='2'/><rect x='420' y='607' width='45' height='37' fill='%23FF1493' stroke='%23333' stroke-width='3'/><ellipse cx='540' cy='645' rx='22' ry='12' fill='%23FF6347' stroke='%23333' stroke-width='2'/><rect x='630' y='622' width='27' height='22' fill='%2332CD32' stroke='%23333' stroke-width='2'/><ellipse cx='720' cy='637' rx='30' ry='16' fill='%23FFD700' stroke='%23333' stroke-width='2'/><rect x='795' y='615' width='42' height='27' fill='%23FF69B4' stroke='%23333' stroke-width='2'/><ellipse cx='885' cy='630' rx='25' ry='15' fill='%234169E1' stroke='%23333' stroke-width='2'/><rect x='960' y='622' width='33' height='18' fill='%23FF4500' stroke='%23333' stroke-width='2'/><ellipse cx='1050' cy='645' rx='37' ry='22' fill='%23ADFF2F' stroke='%23333' stroke-width='2'/></svg>",
                instruction: "Find the wooden spoon, metal spatula, and red tomato in this busy kitchen",
                targetObjects: [
                    { id: "woodenSpoon", name: "Wooden Spoon", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><rect x='22' y='5' width='6' height='25' fill='%23654321' stroke='%23333' stroke-width='1'/><circle cx='25' cy='35' r='6' fill='%23654321' stroke='%23333' stroke-width='1'/></svg>" },
                    { id: "metalSpatula", name: "Metal Spatula", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><rect x='23' y='5' width='4' height='25' fill='%23333'/><rect x='15' y='30' width='20' height='15' fill='%23C0C0C0' stroke='%23333' stroke-width='2'/><line x1='20' y1='35' x2='30' y2='40' stroke='%23333' stroke-width='2'/><line x1='30' y1='35' x2='20' y2='40' stroke='%23333' stroke-width='2'/></svg>" },
                    { id: "redTomato", name: "Red Tomato", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><ellipse cx='25' cy='30' rx='18' ry='15' fill='%23FF6347' stroke='%23333' stroke-width='2'/><rect x='22' y='15' width='6' height='8' fill='%23228B22'/></svg>" }
                ],
                clickableAreas: [
                    { id: "woodenSpoon", x: 1020, y: 525, width: 52, height: 22 },
                    { id: "metalSpatula", x: 930, y: 517, width: 45, height: 52 },
                    { id: "redTomato", x: 150, y: 510, width: 90, height: 60 },
                    // Distractor objects
                    { id: "greenPepper", x: 277, y: 510, width: 82, height: 45 },
                    { id: "yellowBowl", x: 427, y: 517, width: 105, height: 75 },
                    { id: "brownCuttingBoard", x: 622, y: 525, width: 67, height: 37 },
                    { id: "pinkPlate", x: 772, y: 525, width: 75, height: 45 }
                ]
            },
            {
                // Playground Scene - Find specific items and children in a busy playground
                scenarioImage: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='750' viewBox='0 0 1200 750'><defs><linearGradient id='grassGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%2390EE90'/><stop offset='100%25' style='stop-color:%23228B22'/></linearGradient><linearGradient id='skyGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%2387CEEB'/><stop offset='100%25' style='stop-color:%23B0E0E6'/></linearGradient></defs><rect width='1200' height='750' fill='url(%23skyGrad)'/><ellipse cx='1050' cy='120' rx='75' ry='75' fill='%23FFD700' stroke='%23FFA500' stroke-width='6'/><path d='M990 82 L1012 105 M1087 105 L1110 82 M1012 60 L1035 82 M1065 82 L1087 60 M1035 157 L1057 180 M1057 180 L1080 157' stroke='%23FFA500' stroke-width='4'/><rect x='0' y='570' width='1200' height='180' fill='url(%23grassGrad)'/><rect x='105' y='375' width='240' height='195' fill='%23CD853F' stroke='%238B4513' stroke-width='6'/><rect x='127' y='337' width='195' height='37' fill='%23654321' stroke='%23333' stroke-width='4'/><rect x='480' y='270' width='30' height='300' fill='%23654321'/><rect x='457' y='255' width='75' height='30' fill='%23654321'/><rect x='420' y='480' width='150' height='15' fill='%23654321'/><rect x='375' y='495' width='37' height='6' fill='%23333'/><rect x='532' y='495' width='37' height='6' fill='%23333'/><rect x='780' y='345' width='150' height='225' fill='%23FF6347' stroke='%23DC143C' stroke-width='6'/><rect x='817' y='300' width='75' height='52' fill='%23654321'/><circle cx='855' cy='325' r='15' fill='%23FFD700'/><polygon points='675,540 735,480 735,540' fill='%23FF69B4' stroke='%23DC143C' stroke-width='4'/><polygon points='975,570 1035,510 1035,570' fill='%234169E1' stroke='%23000080' stroke-width='4'/><circle cx='240' cy='645' r='45' fill='%23FF1493'/><circle cx='360' cy='660' r='37' fill='%23FFD700'/><circle cx='600' cy='652' r='42' fill='%2332CD32'/><circle cx='870' cy='645' r='33' fill='%23FF4500'/><circle cx='195' cy='480' r='27' fill='%23FFB6C1'/><circle cx='195' cy='450' r='22' fill='%23FDBCB4'/><rect x='184' y='477' width='21' height='52' fill='%23FF69B4'/><rect x='177' y='529' width='12' height='30' fill='%23000'/><rect x='201' y='529' width='12' height='30' fill='%23000'/><circle cx='690' cy='615' r='27' fill='%23FFB6C1'/><circle cx='690' cy='585' r='22' fill='%23FDBCB4'/><rect x='679' y='612' width='21' height='52' fill='%234169E1'/><rect x='672' y='664' width='12' height='30' fill='%23000'/><rect x='696' y='664' width='12' height='30' fill='%23000'/><circle cx='1020' cy='630' r='27' fill='%23FFB6C1'/><circle cx='1020' cy='600' r='22' fill='%23FDBCB4'/><rect x='1009' y='627' width='21' height='52' fill='%2332CD32'/><rect x='1002' y='679' width='12' height='30' fill='%23000'/><rect x='1026' y='679' width='12' height='30' fill='%23000'/><rect x='60' y='675' width='52' height='30' fill='%23654321' stroke='%23333' stroke-width='3'/><ellipse cx='86' cy='690' rx='18' ry='9' fill='%23333'/><rect x='630' y='690' width='60' height='22' fill='%23FF6347' stroke='%23333' stroke-width='3'/><ellipse cx='660' cy='701' rx='22' ry='10' fill='%23333'/><rect x='930' y='682' width='37' height='18' fill='%234169E1' stroke='%23333' stroke-width='3'/><ellipse cx='948' cy='691' rx='15' ry='6' fill='%23333'/></svg>",
                instruction: "Find the red ball, the child in blue shirt, and the wooden sandbox in this playground",
                targetObjects: [
                    { id: "redBall", name: "Red Ball", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><circle cx='25' cy='25' r='20' fill='%23FF1493' stroke='%23DC143C' stroke-width='2'/></svg>" },
                    { id: "blueShirtChild", name: "Child in Blue Shirt", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><circle cx='25' cy='15' r='8' fill='%23FDBCB4'/><rect x='21' y='23' width='8' height='18' fill='%234169E1'/><rect x='19' y='41' width='4' height='8' fill='%23000'/><rect x='27' y='41' width='4' height='8' fill='%23000'/></svg>" },
                    { id: "woodenSandbox", name: "Wooden Sandbox", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><rect x='5' y='20' width='40' height='25' fill='%23CD853F' stroke='%238B4513' stroke-width='3'/><rect x='8' y='17' width='34' height='6' fill='%23654321'/></svg>" }
                ],
                clickableAreas: [
                    { id: "redBall", x: 195, y: 600, width: 90, height: 90 },
                    { id: "blueShirtChild", x: 667, y: 562, width: 45, height: 102 },
                    { id: "woodenSandbox", x: 105, y: 375, width: 240, height: 195 },
                    // Distractor objects
                    { id: "yellowBall", x: 322, y: 622, width: 75, height: 75 },
                    { id: "greenBall", x: 558, y: 610, width: 84, height: 84 },
                    { id: "pinkSlide", x: 645, y: 480, width: 120, height: 90 },
                    { id: "redSlide", x: 780, y: 345, width: 150, height: 225 },
                    { id: "pinkShirtChild", x: 172, y: 427, width: 45, height: 132 },
                    { id: "greenShirtChild", x: 997, y: 577, width: 45, height: 132 }
                ]
            },
            {
                // Street Scene - Find specific vehicles and objects on a busy street
                scenarioImage: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='750' viewBox='0 0 1200 750'><defs><linearGradient id='roadGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%23696969'/><stop offset='100%25' style='stop-color:%232F2F2F'/></linearGradient><linearGradient id='sidewalkGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%23D3D3D3'/><stop offset='100%25' style='stop-color:%23A9A9A9'/></linearGradient></defs><rect width='1200' height='750' fill='%2387CEEB'/><rect x='0' y='480' width='1200' height='180' fill='url(%23roadGrad)'/><rect x='0' y='375' width='1200' height='105' fill='url(%23sidewalkGrad)'/><rect x='0' y='660' width='1200' height='90' fill='url(%23sidewalkGrad)'/><rect x='570' y='480' width='37' height='180' fill='%23FFFF00'/><rect x='105' y='90' width='150' height='285' fill='%23B22222' stroke='%23800000' stroke-width='4'/><rect x='127' y='112' width='30' height='37' fill='%23ADD8E6'/><rect x='165' y='112' width='30' height='37' fill='%23ADD8E6'/><rect x='202' y='112' width='30' height='37' fill='%23ADD8E6'/><rect x='127' y='172' width='30' height='37' fill='%23ADD8E6'/><rect x='165' y='172' width='30' height='37' fill='%23ADD8E6'/><rect x='202' y='172' width='30' height='37' fill='%23ADD8E6'/><rect x='375' y='150' width='120' height='225' fill='%234169E1' stroke='%23000080' stroke-width='4'/><rect x='397' y='172' width='30' height='30' fill='%23ADD8E6'/><rect x='442' y='172' width='30' height='30' fill='%23ADD8E6'/><rect x='397' y='210' width='30' height='30' fill='%23ADD8E6'/><rect x='442' y='210' width='30' height='30' fill='%23ADD8E6'/><rect x='780' y='135' width='135' height='240' fill='%23228B22' stroke='%23006400' stroke-width='4'/><rect x='802' y='157' width='22' height='30' fill='%23ADD8E6'/><rect x='832' y='157' width='22' height='30' fill='%23ADD8E6'/><rect x='870' y='157' width='22' height='30' fill='%23ADD8E6'/><rect x='802' y='195' width='22' height='30' fill='%23ADD8E6'/><rect x='832' y='195' width='22' height='30' fill='%23ADD8E6'/><rect x='870' y='195' width='22' height='30' fill='%23ADD8E6'/><rect x='150' y='525' width='120' height='60' fill='%23FF0000' stroke='%23800000' stroke-width='4'/><rect x='135' y='540' width='18' height='37' fill='%23333'/><rect x='270' y='540' width='18' height='37' fill='%23333'/><circle cx='142' cy='558' r='15' fill='%23000'/><circle cx='277' cy='558' r='15' fill='%23000'/><rect x='165' y='547' width='18' height='15' fill='%23ADD8E6'/><rect x='187' y='547' width='18' height='15' fill='%23ADD8E6'/><rect x='210' y='547' width='18' height='15' fill='%23ADD8E6'/><rect x='232' y='547' width='18' height='15' fill='%23ADD8E6'/><rect x='480' y='517' width='135' height='67' fill='%234169E1' stroke='%23000080' stroke-width='4'/><rect x='465' y='540' width='18' height='45' fill='%23333'/><rect x='615' y='540' width='18' height='45' fill='%23333'/><circle cx='472' cy='562' r='18' fill='%23000'/><circle cx='622' cy='562' r='18' fill='%23000'/><rect x='502' y='540' width='22' height='18' fill='%23ADD8E6'/><rect x='532' y='540' width='22' height='18' fill='%23ADD8E6'/><rect x='562' y='540' width='22' height='18' fill='%23ADD8E6'/><rect x='592' y='540' width='22' height='18' fill='%23ADD8E6'/><rect x='870' y='510' width='150' height='75' fill='%23FFD700' stroke='%23FFA500' stroke-width='4'/><rect x='855' y='540' width='18' height='45' fill='%23333'/><rect x='1020' y='540' width='18' height='45' fill='%23333'/><circle cx='862' cy='562' r='18' fill='%23000'/><circle cx='1027' cy='562' r='18' fill='%23000'/><rect x='892' y='532' width='27' height='22' fill='%23ADD8E6'/><rect x='930' y='532' width='27' height='22' fill='%23ADD8E6'/><rect x='967' y='532' width='27' height='22' fill='%23ADD8E6'/><rect x='1005' y='532' width='27' height='22' fill='%23ADD8E6'/><rect x='1020' y='405' width='30' height='75' fill='%23654321'/><rect x='1012' y='397' width='45' height='18' fill='%23228B22'/><circle cx='1035' cy='412' r='15' fill='%2332CD32'/><rect x='690' y='405' width='22' height='75' fill='%23654321'/><rect x='682' y='397' width='37' height='15' fill='%23FF0000'/><rect x='300' y='412' width='18' height='67' fill='%23C0C0C0'/><rect x='292' y='405' width='33' height='15' fill='%23FF0000'/><rect x='292' y='427' width='33' height='15' fill='%23FFFF00'/><rect x='292' y='450' width='33' height='15' fill='%2332CD32'/></svg>",
                instruction: "Find the red car, the traffic light, and the green tree in this busy street scene",
                targetObjects: [
                    { id: "redCar", name: "Red Car", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><rect x='8' y='20' width='34' height='18' fill='%23FF0000' stroke='%23800000' stroke-width='2'/><circle cx='15' cy='35' r='4' fill='%23000'/><circle cx='35' cy='35' r='4' fill='%23000'/><rect x='12' y='25' width='6' height='4' fill='%23ADD8E6'/><rect x='20' y='25' width='6' height='4' fill='%23ADD8E6'/><rect x='28' y='25' width='6' height='4' fill='%23ADD8E6'/><rect x='36' y='25' width='6' height='4' fill='%23ADD8E6'/></svg>" },
                    { id: "trafficLight", name: "Traffic Light", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><rect x='22' y='5' width='6' height='25' fill='%23C0C0C0'/><rect x='19' y='30' width='12' height='5' fill='%23FF0000'/><rect x='19' y='37' width='12' height='5' fill='%23FFFF00'/><rect x='19' y='44' width='12' height='5' fill='%2332CD32'/></svg>" },
                    { id: "greenTree", name: "Green Tree", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'><rect x='22' y='30' width='6' height='18' fill='%23654321'/><circle cx='25' cy='22' r='12' fill='%2332CD32' stroke='%23228B22' stroke-width='2'/></svg>" }
                ],
                clickableAreas: [
                    { id: "redCar", x: 135, y: 517, width: 150, height: 67 },
                    { id: "trafficLight", x: 285, y: 405, width: 48, height: 75 },
                    { id: "greenTree", x: 1005, y: 397, width: 60, height: 82 },
                    // Distractor objects
                    { id: "blueCar", x: 457, y: 510, width: 172, height: 75 },
                    { id: "yellowCar", x: 847, y: 502, width: 187, height: 82 },
                    { id: "redBuilding", x: 105, y: 90, width: 150, height: 285 },
                    { id: "blueBuilding", x: 375, y: 150, width: 120, height: 225 },
                    { id: "greenBuilding", x: 780, y: 135, width: 135, height: 240 },
                    { id: "redSign", x: 675, y: 397, width: 52, height: 82 }
                ]
            }
        ];

        // Game state for sequence tracking
        let currentSequence = [];
        let expectedSequence = [];

        // Enhanced game variables
        let gameStats = {
            totalClicks: 0,
            correctClicks: 0,
            startTime: null,
            questionStartTime: null
        };
        
        // Use scenarios for quiz questions
        const questions = scenarios;

        let currentQuestionIndex = 0;
        let score = 0;
        let startTime;
        let totalStartTime;
        let triesLeft = 3;
        let timeTaken = [];
        let totalTaps = 0;
        let firstTapTime;
        let incorrectAnswers = 0;
        let correctAnswers = 0;

        // Firebase authentication observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User authenticated in VC4:', user.uid);
                
                try {
                    // Check if user is a doctor
                    if (!isPatientQuiz) {
                        const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                        const role = roleSnapshot.val();
                        
                        if (role === 'doctor') {
                            console.log('Doctor detected without patient context, redirecting');
                            // Redirect doctors without patient context back to index
                            alert('Please select a patient first to administer the quiz.');
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                    
                    // Load user profile
                    let profile;
                    if (isPatientQuiz) {
                        // Doctor viewing patient
                        console.log(`Loading patient profile in VC4: ${currentPatientId}`);
                        const patientSnapshot = await database.ref(`doctors/${doctorId}/patients/${currentPatientId}/profile`).once('value');
                        profile = patientSnapshot.val();
                    } else {
                        // Regular user
                        console.log('Loading user profile in VC4');
                        const userSnapshot = await database.ref(`users/${user.uid}/profile`).once('value');
                        profile = userSnapshot.val();
                    }
                    
                    // Get first letter of name or email
                    let initial = 'U';
                    if (profile && profile.name) {
                        initial = profile.name.charAt(0).toUpperCase();
                    } else if (user.email) {
                        initial = user.email.charAt(0).toUpperCase();
                    }
                    
                    // Display patient indicator
                    if (isPatientQuiz) {
                        const patientIndicator = document.getElementById('patient-indicator');
                        patientIndicator.textContent = 'Patient';
                        patientIndicator.style.display = 'inline-block';
                    } else {
                        const patientIndicator = document.getElementById('patient-indicator');
                        patientIndicator.style.display = 'none';
                    }
                    
                    document.getElementById('profileIcon').textContent = initial;
                    document.getElementById('profileIcon').title = 'Back to Home';
                    
                    totalStartTime = Date.now();
                    displayQuestion();
                } catch (error) {
                    console.error('Error loading profile in VC4:', error);
                    document.getElementById('profileIcon').textContent = 'U';
                    totalStartTime = Date.now();
                    displayQuestion();
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        document.addEventListener("click", () => {
            totalTaps++;
            if (totalTaps === 1) {
                firstTapTime = (Date.now() - totalStartTime) / 1000;
            }
        });

        // Generate a random position for objects that doesn't overlap existing areas
        function generateRandomPosition(imageWidth, imageHeight, existingAreas) {
            // Create random coordinates that don't overlap with existing areas
            let attempts = 0;
            let maxAttempts = 20;
            let x, y, width, height;
            let overlaps = true;
            
            // Keep trying until a non-overlapping position is found or max attempts reached
            while (overlaps && attempts < maxAttempts) {
                x = Math.floor(Math.random() * (imageWidth - 60));
                y = Math.floor(Math.random() * (imageHeight - 60));
                width = Math.floor(Math.random() * 20) + 40;
                height = Math.floor(Math.random() * 20) + 40;
                
                // Check for overlaps with existing areas
                overlaps = existingAreas.some(area => {
                    return !(x > area.x + area.width || 
                             x + width < area.x || 
                             y > area.y + area.height || 
                             y + height < area.y);
                });
                
                attempts++;
            }
            
            return overlaps ? null : { x, y, width, height };
}

        // Create a duplicate object with variations in appearance
        function createDuplicateObject(originalId) {
            const baseId = originalId.replace(/\d+$/, '');
            
            // Add a numeric suffix to differentiate from original
            const newId = baseId + Math.floor(Math.random() * 1000);
            
            return newId;
        }

        function generateRandomBlock(imageWidth, imageHeight) {
            const numBlocks = Math.floor(Math.random() * 2) + 2; // Randomly 2 or 3 blocks
            
            // Store existing block positions to check for collisions
            const existingBlocks = [];

            for (let i = 0; i < numBlocks; i++) {
                // Random width and height
                const blockWidth = Math.floor(Math.random() * (imageWidth / 3)) + 30; // Random width between 30px and imageWidth/3
                const blockHeight = Math.floor(Math.random() * (imageHeight / 3)) + 30; // Random height between 30px and imageHeight/3

                // Generate random position and check for collisions
                let blockX, blockY;
                let collisionDetected;

                do {
                    collisionDetected = false;
                    blockX = Math.floor(Math.random() * (imageWidth - blockWidth + 150));
                    blockY = Math.floor(Math.random() * (imageHeight - blockHeight));

                    // Check if the new block collides with any existing block
                    for (let j = 0; j < existingBlocks.length; j++) {
                        const existingBlock = existingBlocks[j];
                        const distanceX = Math.abs(blockX - existingBlock.x);
                        const distanceY = Math.abs(blockY - existingBlock.y);

                        if (distanceX < (blockWidth + existingBlock.width) / 2 && distanceY < (blockHeight + existingBlock.height) / 2) {
                            collisionDetected = true;
                            break;
                        }
                    }
                } while (collisionDetected); // Keep generating until no collision is detected

                // Create a div element for the block
                const block = document.createElement('div');
                block.style.position = 'absolute';
                block.style.backgroundColor = 'white';
                block.style.width = `${blockWidth}px`;
                block.style.height = `${blockHeight}px`;
                block.style.top = `${blockY}px`;
                block.style.left = `${blockX}px`;

                // Add the block's position and size to the existing blocks array
                existingBlocks.push({ x: blockX, y: blockY, width: blockWidth, height: blockHeight });

                // Append the block to the question image container if needed
                // const questionImage = document.querySelector('#question-container img');
                // if (questionImage && questionImage.parentNode) {
                //     questionImage.parentNode.appendChild(block);
                // }
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }

            gameStats.questionStartTime = Date.now();
            if (!gameStats.startTime) gameStats.startTime = Date.now();
            
            const currentScenario = questions[currentQuestionIndex];
            
            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressFill.style.width = progress + '%';
            
            const questionContainer = document.getElementById('question-container');
            const targetObjectsContainer = document.getElementById('target-objects');
            const scenarioContainer = document.getElementById('scenario-container');
            const scenarioImage = document.getElementById('scenario-image');
            const instructionText = document.getElementById('instructionText');
            const sequenceStatus = document.getElementById('sequenceStatus');
            
            questionContainer.style.display = 'block';
            
            // Set instruction text
            instructionText.textContent = currentScenario.instruction || 'Find and click on these objects in the scene below:';
            
            // Handle sequence-based tests
            if (currentScenario.sequenceRequired) {
                currentSequence = [];
                expectedSequence = currentScenario.correctSequence;
                sequenceStatus.style.display = 'block';
                sequenceStatus.textContent = `Next: Click ${expectedSequence[0].replace('number', '').replace('letter', '')}`;
            } else {
                sequenceStatus.style.display = 'none';
            }
            
            // Clear containers
            targetObjectsContainer.innerHTML = '';
            const existingAreas = scenarioContainer.querySelectorAll('.clickable-area, .scenario-object');
            existingAreas.forEach(area => area.remove());
            
            // Set the scenario image
            scenarioImage.src = currentScenario.scenarioImage;
            
            // Display target objects with improved styling
            currentScenario.targetObjects.forEach(targetObj => {
                const img = document.createElement('img');
                img.src = targetObj.image;
                img.alt = targetObj.name;
                img.title = targetObj.name;
                img.className = 'target-object';
                img.dataset.id = targetObj.id;
                img.style.cssText = `
                    width: 70px;
                    height: 70px;
                    object-fit: contain;
                    border: 3px solid #dee2e6;
                    border-radius: 12px;
                    padding: 8px;
                    background: white;
                    margin: 8px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    cursor: pointer;
                `;
                targetObjectsContainer.appendChild(img);
            });
            
            // Wait for the image to load before adding clickable areas
            scenarioImage.onload = () => {
                const imgWidth = scenarioImage.offsetWidth;
                const imgHeight = scenarioImage.offsetHeight;
                
                // Create clickable areas for all objects
                currentScenario.clickableAreas.forEach(area => {
                    const clickableDiv = document.createElement('div');
                    clickableDiv.className = 'clickable-area';
                    clickableDiv.dataset.id = area.id;
                    
                    // Scale coordinates to actual image size
                    const scaleX = imgWidth / 600; // Assuming SVG is 600px wide
                    const scaleY = imgHeight / 400; // Assuming SVG is 400px tall
                    
                    clickableDiv.style.cssText = `
                        position: absolute;
                        left: ${area.x * scaleX}px;
                        top: ${area.y * scaleY}px;
                        width: ${area.width * scaleX}px;
                        height: ${area.height * scaleY}px;
                        background-color: transparent;
                        cursor: pointer;
                        border: 2px solid transparent;
                        border-radius: 8px;
                        transition: all 0.3s ease;
                        z-index: 10;
                    `;
                    
                    clickableDiv.addEventListener('mouseenter', () => {
                        clickableDiv.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
                        clickableDiv.style.borderColor = '#4CAF50';
                    });
                    
                    clickableDiv.addEventListener('mouseleave', () => {
                        clickableDiv.style.backgroundColor = 'transparent';
                        clickableDiv.style.borderColor = 'transparent';
                    });
                    
                    clickableDiv.addEventListener('click', () => handleObjectClick(area.id, clickableDiv));
                    
                    scenarioContainer.appendChild(clickableDiv);
                });
            };
        }
        
        function handleObjectClick(objectId, clickableElement) {
            gameStats.totalClicks++;
            
            const currentScenario = questions[currentQuestionIndex];
            const isTargetObject = currentScenario.targetObjects.some(obj => obj.id === objectId);
            
            // Visual feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 2rem;
                font-weight: bold;
                z-index: 100;
                animation: feedbackPop 0.8s ease-out;
                pointer-events: none;
            `;
            
            let isCorrectClick = false;
            
            // Handle sequence-based tests
            if (currentScenario.sequenceRequired) {
                const expectedNext = expectedSequence[currentSequence.length];
                if (objectId === expectedNext) {
                    isCorrectClick = true;
                    currentSequence.push(objectId);
                    
                    const sequenceStatus = document.getElementById('sequenceStatus');
                    if (currentSequence.length < expectedSequence.length) {
                        const nextItem = expectedSequence[currentSequence.length];
                        sequenceStatus.textContent = `Next: Click ${nextItem.replace('number', '').replace('letter', '')}`;
                    } else {
                        sequenceStatus.textContent = 'Sequence completed! ‚úÖ';
                        sequenceStatus.style.background = '#d4edda';
                        sequenceStatus.style.color = '#155724';
                    }
                } else {
                    // Wrong sequence item clicked
                    feedback.textContent = '‚ùå';
                    feedback.style.color = '#f44336';
                    clickableElement.style.backgroundColor = 'rgba(244, 67, 54, 0.3)';
                    clickableElement.style.borderColor = '#f44336';
                    
                    setTimeout(() => {
                        clickableElement.style.backgroundColor = 'transparent';
                        clickableElement.style.borderColor = 'transparent';
                    }, 500);
                }
            } else {
                // Regular target object test
                isCorrectClick = isTargetObject;
            }
            
            if (isCorrectClick) {
                gameStats.correctClicks++;
                feedback.textContent = '‚úÖ';
                feedback.style.color = '#4CAF50';
                clickableElement.style.backgroundColor = 'rgba(76, 175, 80, 0.6)';
                clickableElement.style.borderColor = '#4CAF50';
                clickableElement.style.pointerEvents = 'none';
                
                // Mark target object as found (for non-sequence tests)
                if (!currentScenario.sequenceRequired) {
                    const targetImg = document.querySelector(`[data-id="${objectId}"]`);
                    if (targetImg) {
                        targetImg.style.opacity = '0.5';
                        targetImg.style.border = '3px solid #4CAF50';
                    }
                }
                
                // Check completion conditions
                let isComplete = false;
                if (currentScenario.sequenceRequired) {
                    isComplete = currentSequence.length === expectedSequence.length;
                } else {
                    // Count found targets
                    const totalTargets = currentScenario.clickableAreas.filter(area => 
                        currentScenario.targetObjects.some(obj => obj.id === area.id)
                    ).length;
                    const foundTargets = currentScenario.clickableAreas.filter(area => {
                        const element = document.querySelector(`[data-id="${area.id}"]`);
                        return element && element.style.pointerEvents === 'none';
                    }).length;
                    isComplete = foundTargets >= totalTargets;
                }
                
                if (isComplete) {
                    setTimeout(() => {
                        currentQuestionIndex++;
                        displayQuestion();
                    }, 1500);
                }
            } else if (!currentScenario.sequenceRequired) {
                feedback.textContent = '‚ùå';
                feedback.style.color = '#f44336';
                clickableElement.style.backgroundColor = 'rgba(244, 67, 54, 0.3)';
                clickableElement.style.borderColor = '#f44336';
                
                setTimeout(() => {
                    clickableElement.style.backgroundColor = 'transparent';
                    clickableElement.style.borderColor = 'transparent';
                }, 500);
            }
            
            clickableElement.appendChild(feedback);
            setTimeout(() => feedback.remove(), 800);
        }

        // Add CSS animation for feedback
        const style = document.createElement('style');
        style.textContent = `
            @keyframes feedbackPop {
                0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
            }
            
            .game-controls {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin-top: 20px;
            }
        `;
        document.head.appendChild(style);

        function startQuiz() {
            gameStats = {
                totalClicks: 0,
                correctClicks: 0,
                startTime: Date.now(),
                questionStartTime: null
            };
            currentQuestionIndex = 0;
            displayQuestion();
        }

        function skipQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= questions.length) {
                showResults();
            } else {
                displayQuestion();
            }
        }

        function showResults() {
            const totalTime = (Date.now() - gameStats.startTime) / 1000;
            const accuracy = gameStats.totalClicks > 0 ? (gameStats.correctClicks / gameStats.totalClicks * 100).toFixed(1) : 0;
            
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('result-container').style.display = 'block';
            
            document.getElementById('score').textContent = `${gameStats.correctClicks}/${questions.length * 3} objects found`;
            document.getElementById('total-time').textContent = totalTime.toFixed(1);
            document.getElementById('avg-time').textContent = (totalTime / questions.length).toFixed(1);
            document.getElementById('first-tap').textContent = '0.5';
            document.getElementById('total-taps').textContent = gameStats.totalClicks;
            document.getElementById('total-correct').textContent = gameStats.correctClicks;
            document.getElementById('total-incorrect').textContent = gameStats.totalClicks - gameStats.correctClicks;
        }

        // Initialize the quiz
        window.onload = function() {
            startQuiz();
        };

        function checkAnswer(areaId) {
            const endTime = Date.now();
            const timeSpent = (endTime - startTime) / 1000;
            timeTaken.push(timeSpent);
            
            // Record the first tap time if not already set
            if (firstTapTime === null) {
                firstTapTime = timeSpent;
            }
            
            // Increment total taps counter
            totalTaps++;
            
            const currentScenario = questions[currentQuestionIndex];
            const targetIds = currentScenario.targetObjects.map(obj => obj.id);
            
            if (targetIds.includes(areaId)) {
                // Found a target object
                score++;
                correctAnswers++;
                
                // Create a success animation at the clicked position
                const clickedArea = document.querySelector(`.scenario-object[data-id="${areaId}"]`);
                if (!clickedArea) return; // Safety check
                
                const scenarioContainer = document.getElementById('scenario-container');
                
                // Create a success indicator
                const successMark = document.createElement('div');
                successMark.className = 'feedback-mark success-mark';
                successMark.innerHTML = '‚úì';
                successMark.style.position = 'absolute';
                successMark.style.left = clickedArea.style.left;
                successMark.style.top = clickedArea.style.top;
                successMark.style.fontSize = '2rem';
                successMark.style.color = '#4CAF50';
                successMark.style.fontWeight = 'bold';
                successMark.style.zIndex = '10';
                successMark.style.textShadow = '0px 0px 3px white';
                scenarioContainer.appendChild(successMark);
                
                // Disable the clicked area to prevent multiple clicks
                clickedArea.style.pointerEvents = 'none';
                clickedArea.style.opacity = '0.7';
                
                // Mark the found target in the target list
                const targetImage = document.querySelector(`.target-object[data-id="${areaId}"]`);
                if (targetImage) {
                    targetImage.style.opacity = '0.3';
                    targetImage.style.border = '2px solid #4CAF50';
                }
                
                // Check if all targets have been found
                const foundTargets = document.querySelectorAll('.target-object[style*="opacity: 0.3"]');
                if (foundTargets.length === currentScenario.targetObjects.length) {
                    // All targets found, proceed to next scenario after a short delay
                    setTimeout(() => {
                        moveToNextQuestion();
                    }, 1000);
                }
            } else {
                // Incorrect selection
                triesLeft--;
                incorrectAnswers++;
                
                // Create a failure indicator
                const clickedArea = document.querySelector(`.scenario-object[data-id="${areaId}"]`);
                if (!clickedArea) return; // Safety check
                
                const scenarioContainer = document.getElementById('scenario-container');
                
                const failMark = document.createElement('div');
                failMark.className = 'feedback-mark fail-mark';
                failMark.innerHTML = '‚úó';
                failMark.style.position = 'absolute';
                failMark.style.left = clickedArea.style.left;
                failMark.style.top = clickedArea.style.top;
                failMark.style.fontSize = '2rem';
                failMark.style.color = '#F44336';
                failMark.style.fontWeight = 'bold';
                failMark.style.zIndex = '10';
                failMark.style.textShadow = '0px 0px 3px white';
                scenarioContainer.appendChild(failMark);
                
                // Briefly disable this distractor to prevent repeated clicks
                clickedArea.style.pointerEvents = 'none';
                setTimeout(() => {
                    clickedArea.style.pointerEvents = 'auto';
                    // Remove the fail mark after a delay
                    if (failMark.parentNode) {
                        failMark.parentNode.removeChild(failMark);
                    }
                }, 1000);
                
                if (triesLeft <= 0) {
                    // No more tries, move to next question
                    setTimeout(() => {
                        moveToNextQuestion();
                    }, 1000);
                }
            }
        }

        function skipQuestion() {
            incorrectAnswers++;
            alert('You skipped this question!');
            moveToNextQuestion();
        }

        function moveToNextQuestion() {
            // Remove any existing skip button
            const existingSkipButton = document.querySelector('#quiz-container > button');
            if (existingSkipButton) {
                existingSkipButton.remove();
            }
            
            // Reset tries for the next question
            triesLeft = 3;
            currentQuestionIndex++;
            
            // Check if we have more questions or should show results
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }
        
        function showResults() {
            // Calculate scores and stats
            const totalTime = timeTaken.reduce((a, b) => a + b, 0).toFixed(2);
            const averageTime = (totalTime / Math.max(1, timeTaken.length)).toFixed(2);
            
            // Display results
            const questionContainer = document.getElementById('question-container');
            questionContainer.style.display = 'none';
            
            const imagesContainer = document.getElementById('images-container');
            if (imagesContainer) { // Check if element exists first
                imagesContainer.style.display = 'none';
            }
            
            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';
            
            document.getElementById('score').textContent = score;
            document.getElementById('total-time').textContent = totalTime;
            document.getElementById('avg-time').textContent = averageTime;
            document.getElementById('first-tap').textContent = firstTapTime ? firstTapTime.toFixed(2) : 'N/A';
            document.getElementById('total-taps').textContent = totalTaps;
            document.getElementById('total-correct').textContent = correctAnswers;
            document.getElementById('total-incorrect').textContent = incorrectAnswers;
            
            // Save results to database
            saveQuizResults(
                score,
                parseFloat(totalTime),
                parseFloat(averageTime),
                firstTapTime ? parseFloat(firstTapTime.toFixed(2)) : 0,
                totalTaps,
                correctAnswers,
                incorrectAnswers
            );
            
            // Display previous attempts
            displayPreviousAttempts();
        }
        
        async function displayPreviousAttempts() {
            // Show the report container
            const reportContainer = document.getElementById('report-container');
            reportContainer.style.display = 'flex';
            
            const reportList = document.getElementById('report-list');
            reportList.innerHTML = '<h3>Previous Attempts</h3>';
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    reportList.innerHTML += '<p>You must be logged in to view previous attempts.</p>';
                    return;
                }
                
                // Get data path based on session
                let path;
                if (currentPatientId && doctorId) {
                    // Doctor viewing patient quiz
                    path = `doctors/${doctorId}/patients/${currentPatientId}/quiz/VC4`;
                } else {
                    // Check if user is a doctor
                    const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                    const role = roleSnapshot.val();
                    
                    if (role === 'doctor') {
                        path = `doctors/${user.uid}/quiz/VC4`;
                    } else {
                        path = `users/${user.uid}/quiz/VC4`;
                    }
                }
                
                // Get attempts data
                const attemptsSnapshot = await database.ref(path).once('value');
                const attempts = attemptsSnapshot.val();
                
                if (attempts) {
                    // Convert object to array and sort by timestamp descending
                    const attemptsArray = Object.entries(attempts).map(([key, value]) => {
                        return { ...value, id: key };
                    }).sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Display each attempt
                    attemptsArray.forEach((attempt, index) => {
                        // Create attempt item container
                        const attemptItem = document.createElement('div');
                        attemptItem.className = 'attempt-item';
                        
                        const date = new Date(attempt.timestamp);
                        const dateString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        // Create date and score section
                        const dateScoreDiv = document.createElement('div');
                        dateScoreDiv.innerHTML = `
                            <div class="attempt-date">${dateString}</div>
                            <div class="attempt-score">Score: ${attempt.score}</div>
                        `;
                        attemptItem.appendChild(dateScoreDiv);
                        
                        // Create details div (initially hidden)
                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'attempt-details';
                        detailsDiv.innerHTML = `
                            <div class="attempt-detail-item">
                                <span class="detail-label">Total Time:</span>
                                <span>${attempt.totalTime.toFixed(2)}s</span>
                            </div>
                            <div class="attempt-detail-item">
                                <span class="detail-label">Avg Time:</span>
                                <span>${attempt.averageTime.toFixed(2)}s</span>
                            </div>
                            <div class="attempt-detail-item">
                                <span class="detail-label">First Tap:</span>
                                <span>${attempt.firstTapTime ? attempt.firstTapTime.toFixed(2) + 's' : 'N/A'}</span>
                            </div>
                            <div class="attempt-detail-item">
                                <span class="detail-label">Total Taps:</span>
                                <span>${attempt.totalTaps || 0}</span>
                            </div>
                            <div class="attempt-detail-item">
                                <span class="detail-label">Correct:</span>
                                <span>${attempt.correctAnswers || 0}</span>
                            </div>
                            <div class="attempt-detail-item">
                                <span class="detail-label">Incorrect:</span>
                                <span>${attempt.incorrectAnswers || 0}</span>
                            </div>
                        `;
                        attemptItem.appendChild(detailsDiv);
                        
                        // Add toggle details button
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'toggle-details-btn';
                        toggleBtn.textContent = 'Show Details';
                        toggleBtn.style.minHeight = '26px';
                        toggleBtn.style.padding = '5px 10px';
                        toggleBtn.style.fontSize = '0.9rem';
                        toggleBtn.onclick = function() {
                            if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
                                detailsDiv.style.display = 'grid';
                                this.textContent = 'Hide Details';
                            } else {
                                detailsDiv.style.display = 'none';
                                this.textContent = 'Show Details';
                            }
                        };
                        dateScoreDiv.appendChild(toggleBtn);
                        
                        // Initially hide details
                        detailsDiv.style.display = 'none';
                        
                        reportList.appendChild(attemptItem);
                    });
                } else {
                    reportList.innerHTML += '<p>No previous attempts found.</p>';
                }
            } catch (error) {
                console.error('Error fetching previous attempts:', error);
            }
        }
        
        // Function to return to Visual Cognition page
        function returnToVC() {
            window.location.href = 'VC.html';
        }
        
        // This function handles restarting the quiz
        function restartQuiz() {
            // Reset all quiz variables
            currentQuestionIndex = 0;
            score = 0;
            timeTaken = [];
            totalTaps = 0;
            correctAnswers = 0;
            incorrectAnswers = 0;
            firstTapTime = null;
            totalStartTime = Date.now();
            
            // Hide results container
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('report-container').style.display = 'none';
            
            // Show question container
            document.getElementById('question-container').style.display = 'block';
            document.getElementById('images-container').style.display = 'flex';
            
            // Start the quiz
            displayQuestion();
        }

        async function saveQuizResults(score, totalTime, averageTime, firstTapTime, totalTaps, correctAnswers, incorrectAnswers) {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const timestamp = Date.now();
                let path;

                // Check if this is a patient quiz (doctor viewing patient)
                if (currentPatientId && doctorId) {
                    // This is a doctor testing a patient
                    console.log(`Saving patient quiz results - Doctor: ${doctorId}, Patient: ${currentPatientId}`);
                    path = `doctors/${doctorId}/patients/${currentPatientId}/quiz/VC4/${timestamp}`;
                } else {
                    // Regular user quiz
                    // Check if user is a doctor
                    const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                    const role = roleSnapshot.val();
                    
                    if (role === 'doctor') {
                        console.log(`Saving doctor's own quiz results: ${user.uid}`);
                        path = `doctors/${user.uid}/quiz/VC4/${timestamp}`;
                    } else {
                        console.log(`Saving regular user quiz results: ${user.uid}`);
                        path = `users/${user.uid}/quiz/VC4/${timestamp}`;
                    }
                }

                console.log(`Saving quiz results to path: ${path}`);
                await database.ref(path).set({
                    score,
                    totalTime,
                    averageTime,
                    firstTapTime,
                    totalTaps,
                    correctAnswers,
                    incorrectAnswers,
                    timestamp
                });
                
                console.log('Quiz results saved successfully');
            } catch (error) {
                console.error('Error saving quiz results:', error);
            }
        }

        async function clearReport() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('You must be logged in to clear reports.');
                    return;
                }
                
                // First, let's confirm the action
                const confirmClear = confirm('Are you sure you want to clear all reports? This action cannot be undone.');
                if (!confirmClear) {
                    return;
                }
                
                // Get patient context from sessionStorage
                const currentPatientId = sessionStorage.getItem('currentPatientId');
                const doctorId = sessionStorage.getItem('doctorId');
                
                // Determine path based solely on sessionStorage
                let path = '';
                
                if (currentPatientId && doctorId) {
                    // Doctor viewing patient quiz
                    console.log(`Clearing reports for patient ${currentPatientId} viewed by doctor ${doctorId}`);
                    path = `doctors/${doctorId}/patients/${currentPatientId}/quiz/VC4`;
                } else {
                    // Regular user's own quiz results
                    console.log(`Clearing reports for user ${user.uid}`);
                    path = `users/${user.uid}/quiz/VC4`;
                }
                
                console.log('Clearing reports at path:', path);
                
                // Remove the data (use set with null as a fallback if remove doesn't work)
                try {
                    await database.ref(path).remove();
                } catch (removeError) {
                    console.warn('Remove failed, trying set(null):', removeError);
                    await database.ref(path).set(null);
                }
                
                // Show confirmation and refresh the report list
                alert('All reports have been cleared successfully!');
                
                // Update UI
                const reportList = document.getElementById('report-list');
                reportList.innerHTML = '<h3>Previous Attempts</h3><p>No previous attempts found.</p>';
                
                console.log('Reports cleared successfully');
            } catch (error) {
                console.error('Error clearing reports:', error);
                alert('Failed to clear reports: ' + error.message);
            }
        }

        function restartQuiz() {
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('report-container').style.display = 'none';
            document.getElementById('question-container').style.display = 'block';
            document.getElementById('images-container').style.display = 'grid';
            currentQuestionIndex = 0;
            score = 0;
            triesLeft = 3;
            timeTaken = [];
            incorrectAnswers = 0;
            totalTaps = 0;
            correctAnswers = 0;
            totalStartTime = Date.now();
            displayQuestion();
        }
    </script>
</body>
</html>