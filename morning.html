<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Routine Quiz</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            width: 100%;
            max-width: 650px;
            position: relative;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5em;
        }

        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.3s;
            font-size: 16px;
        }
        
        .profile-icon:hover {
            background-color: #1976D2;
        }

        .user-info {
            display: flex;
            align-items: center;
        }
        
        .patient-indicator {
            display: none;
            padding: 3px 8px;
            background-color: #e9f5e9;
            color: #4CAF50;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 110px);
            grid-template-rows: repeat(2, 110px);
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .box-placeholder {
            width: 90px;
            height: 90px;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
        }

        .target-box {
            width: 90px;
            height: 90px;
            border: 3px dashed #4CAF50;
            border-radius: 10px;
            position: absolute;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            z-index: 10;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(3, 110px);
            grid-template-rows: repeat(2, 110px);
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .image-option {
            width: 90px;
            height: 90px;
            border: 2px solid #2196F3;
            border-radius: 10px;
            cursor: grab;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
            justify-self: center;
            align-self: center;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .image-option.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .image-option.placed {
            visibility: hidden;
        }

        .image-option.invalid {
            border-color: #f44336;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .feedback {
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            color: #4CAF50;
            min-height: 24px;
        }

        button {
            padding: 10px 15px;
            font-size: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        #result-container {
            display: none;
            margin: 20px auto;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
        }

        #result-container h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        #result-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        #result-container li {
            margin: 10px 0;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        #report-container {
            margin: 40px auto;
            width: 80%;
            max-width: 600px;
            display: none;
        }

        #report-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #report-list {
            list-style-type: none;
            padding: 0;
            margin-bottom: 20px;
        }

        #report-list li {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            font-size: 14px;
            line-height: 1.4;
        }

        .attempt-item {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .attempt-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .attempt-date {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .attempt-score {
            color: #4CAF50;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
        }
        
        .attempt-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            color: #333;
            font-size: 14px;
        }

        #clear-report {
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #clear-report:hover {
            background-color: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                max-width: 95%;
            }
            
            .grid-container,
            .options-container {
                grid-template-columns: repeat(3, 90px);
                grid-template-rows: repeat(2, 90px);
                gap: 10px;
            }
            
            .box-placeholder,
            .image-option,
            .target-box {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Morning Routine Quiz</h1>
            <div class="profile-icon" id="profileIcon" title="Back to Home" onclick="window.location.href='index.html'"></div>
            <div class="user-info">
                <span id="patient-indicator" class="patient-indicator"></span>
            </div>
        </div>
        
        <div class="grid-container" id="sequence-container">
            <div class="box-placeholder"></div>
            <div class="box-placeholder"></div>
            <div class="box-placeholder"></div>
            <div class="box-placeholder"></div>
            <div class="box-placeholder"></div>
            <div class="box-placeholder"></div>
            <div class="target-box" id="target-box"></div>
        </div>
        
        <div class="options-container" id="options-container"></div>
        
        <div class="feedback" id="feedback"></div>
        
        <div class="button-container">
            <button id="reset-button">New Game</button>
            <button id="home-button" onclick="window.location.href='index.html'">Home</button>
        </div>
    </div>

    <div id="result-container">
        <h2>Quiz Results</h2>
        <ul>
            <li><strong>Score:</strong> <span id="score">0</span></li>
            <li><strong>Total Time:</strong> <span id="total-time-result">0</span> seconds</li>
            <li><strong>Average Time:</strong> <span id="avg-time">0</span> seconds</li>
            <li><strong>First Tap Time:</strong> <span id="first-tap">0</span> seconds</li>
            <li><strong>Total Taps:</strong> <span id="total-taps-result">0</span></li>
            <li><strong>Total Correct Answers:</strong> <span id="total-correct">0</span></li>
            <li><strong>Total Incorrect Answers:</strong> <span id="total-incorrect">0</span></li>
        </ul>
        <div class="button-container">
            <a href="index.html" style="text-decoration: none;">
                <button class="home-button">Return Home</button>
            </a>
        </div>
    </div>

    <div id="report-container">
        <h2>All Quiz Attempts</h2>
        <ul id="report-list"></ul>
        <button id="clear-report" onclick="clearReport()">Clear Report</button>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFENL5Z_2Cewh4p6zp_BZtxL9n0di-9u8",
            authDomain: "projeccvi.firebaseapp.com",
            projectId: "projeccvi",
            databaseURL: "https://projeccvi-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "projeccvi.appspot.com",
            messagingSenderId: "279067566247",
            appId: "1:279067566247:web:9cf00f7bf1ea3549fabb82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // Get quiz context from session storage
        const patientId = sessionStorage.getItem('currentPatientId');
        const doctorId = sessionStorage.getItem('doctorId');
        const isPatientQuiz = !!patientId;
        
        console.log('Quiz context in Morning Quiz:', { 
            isPatientQuiz, 
            patientId: patientId || 'none',
            doctorId: doctorId || 'none'
        });

        // Variables
        let userId = null;
        let isDoctor = false;
        let isDoctorViewingPatient = false;

        // Game variables
        let currentIndex = 0;
        let score = 0;
        let totalStartTime = 0;
        let firstTapTime = null;
        let totalMoves = 0;
        let incorrectMoves = 0;
        let totalTaps = 0;
        let correctPlacements = 0;
        let incorrectPlacements = 0;
        let gameActive = false;

        // List of images in correct order
        const images = [
            './images/VSM/morning/1.jpg',
            './images/VSM/morning/2.jpg',
            './images/VSM/morning/3.jpg',
            './images/VSM/morning/4.jpg',
            './images/VSM/morning/5.jpg',
            './images/VSM/morning/6.jpg'
        ];

        // DOM elements
        const sequenceContainer = document.getElementById('sequence-container');
        const optionsContainer = document.getElementById('options-container');
        const targetBox = document.getElementById('target-box');
        const feedbackElement = document.getElementById('feedback');
        const resultContainer = document.getElementById('result-container');
        const profileIcon = document.getElementById('profileIcon');
        const resetButton = document.getElementById('reset-button');

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                console.log('User authenticated in Morning Quiz:', userId);
                
                try {
                    // Check if user is a doctor without patient context
                    if (!isPatientQuiz) {
                        const roleSnapshot = await db.ref(`roles/${user.uid}`).once('value');
                        const role = roleSnapshot.val();
                        
                        if (role === 'doctor') {
                            console.log('Doctor detected without patient context, redirecting');
                            alert('Please select a patient first to administer the quiz.');
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                    
                    // Load user profile
                    let profile;
                    if (isPatientQuiz) {
                        // Doctor viewing patient
                        isDoctorViewingPatient = true;
                        isDoctor = true;
                        
                        console.log(`Loading patient profile: ${patientId}`);
                        const patientSnapshot = await db.ref(`doctors/${doctorId || userId}/patients/${patientId}/profile`).once('value');
                        profile = patientSnapshot.val();
                        
                        // Show patient indicator
                        if (profile) {
                            const patientName = profile.name || 'Patient';
                            const patientIndicator = document.getElementById('patient-indicator');
                            patientIndicator.textContent = `Patient: ${patientName}`;
                            patientIndicator.style.display = 'inline-block';
                        }
                    } else {
                        // Regular user
                        const userSnapshot = await db.ref(`users/${user.uid}/profile`).once('value');
                        profile = userSnapshot.val();
                        
                        if (profile && profile.role === 'doctor') {
                            isDoctor = true;
                        }
                    }
                    
                    // Set profile icon initials
                    if (profile && profile.name) {
                        setProfileInitials(profile.name);
                    } else {
                        const email = user.email || 'User';
                        setProfileInitials(email);
                    }
                    
                    // Initialize the game
                    initializeGame();
                    fetchPreviousAttempts();
                    
                } catch (error) {
                    console.error('Error setting up quiz:', error);
                    alert('Error loading profile. Please try again.');
                }
            } else {
                // Not logged in, redirect to login page
                window.location.href = 'login.html';
            }
        });

        // Initialize the game
        function initializeGame() {
            // Set up the placeholders
            const placeholders = sequenceContainer.querySelectorAll('.box-placeholder');
            placeholders.forEach((placeholder) => {
                placeholder.style.backgroundImage = '';
                placeholder.dataset.filled = 'false';
            });

            // Set the target box position to the first placeholder
            const firstPlaceholder = placeholders[0];
            const rect = firstPlaceholder.getBoundingClientRect();
            const containerRect = sequenceContainer.getBoundingClientRect();

            targetBox.style.left = (firstPlaceholder.offsetLeft) + 'px';
            targetBox.style.top = (firstPlaceholder.offsetTop) + 'px';

            // Set up option images (shuffled)
            optionsContainer.innerHTML = '';
            const shuffledImages = shuffleArray([...images]);

            shuffledImages.forEach((image, index) => {
                const optionElement = document.createElement('div');
                optionElement.classList.add('image-option');
                optionElement.style.backgroundImage = `url(${image})`;
                optionElement.dataset.index = images.indexOf(image);

                // Set up drag for desktop
                optionElement.draggable = true;
                optionElement.addEventListener('dragstart', handleDragStart);
                optionElement.addEventListener('dragend', handleDragEnd);

                // Set up touch for mobile
                optionElement.addEventListener('touchstart', handleTouchStart, false);
                optionElement.addEventListener('touchmove', handleTouchMove, false);
                optionElement.addEventListener('touchend', handleTouchEnd, false);

                // Add click event for selecting an image
                optionElement.addEventListener('click', function() {
                    if (!gameActive) return;

                    // Track first tap time
                    if (firstTapTime === null) {
                        firstTapTime = (Date.now() - totalStartTime) / 1000;
                    }

                    totalTaps++;

                    const selectedIndex = parseInt(this.dataset.index);
                    placeImage(this, selectedIndex);
                });

                optionsContainer.appendChild(optionElement);
            });

            // Reset game variables
            currentIndex = 0;
            totalStartTime = Date.now();
            firstTapTime = null;
            totalMoves = 0;
            incorrectMoves = 0;
            totalTaps = 0;
            score = 0;
            correctPlacements = 0;
            incorrectPlacements = 0;
            gameActive = true;

            feedbackElement.textContent = "Place the morning routine activities in the correct order.";

            document.querySelector('.container').style.display = 'block';
            resultContainer.style.display = 'none';

            // Set up drag and drop target
            targetBox.addEventListener('dragover', handleDragOver);
            targetBox.addEventListener('drop', handleDrop);
        }

        // Drag event handlers
        function handleDragStart(e) {
            if (!gameActive) return;
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!gameActive) return;

            // Track first tap time
            if (firstTapTime === null) {
                firstTapTime = (Date.now() - totalStartTime) / 1000;
            }

            totalTaps++;

            const selectedIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const optionElement = document.querySelector(`.image-option[data-index="${selectedIndex}"]`);

            placeImage(optionElement, selectedIndex);
        }

        // Touch event handlers (for mobile)
        let touchedElement = null;
        let initialTouchX = 0;
        let initialTouchY = 0;
        let clonedElement = null;

        function handleTouchStart(e) {
            if (!gameActive) return;
            e.preventDefault();

            touchedElement = this;
            const touch = e.touches[0];
            initialTouchX = touch.clientX;
            initialTouchY = touch.clientY;

            // Create a clone for visual feedback during drag
            clonedElement = this.cloneNode(true);
            clonedElement.style.position = 'fixed';
            clonedElement.style.zIndex = 1000;
            clonedElement.style.opacity = '0.8';
            clonedElement.style.pointerEvents = 'none';
            clonedElement.style.left = (touch.clientX - this.offsetWidth / 2) + 'px';
            clonedElement.style.top = (touch.clientY - this.offsetHeight / 2) + 'px';
            document.body.appendChild(clonedElement);

            this.classList.add('dragging');
        }

        function handleTouchMove(e) {
            if (!touchedElement || !clonedElement) return;
            e.preventDefault();

            const touch = e.touches[0];
            clonedElement.style.left = (touch.clientX - touchedElement.offsetWidth / 2) + 'px';
            clonedElement.style.top = (touch.clientY - touchedElement.offsetHeight / 2) + 'px';
        }

        function handleTouchEnd(e) {
            if (!touchedElement || !clonedElement) return;
            e.preventDefault();

            touchedElement.classList.remove('dragging');

            // Track first tap time
            if (firstTapTime === null) {
                firstTapTime = (Date.now() - totalStartTime) / 1000;
            }

            totalTaps++;

            // Check if touch ended over target box
            const targetRect = targetBox.getBoundingClientRect();
            const touch = e.changedTouches[0];

            if (touch.clientX >= targetRect.left && touch.clientX <= targetRect.right &&
                touch.clientY >= targetRect.top && touch.clientY <= targetRect.bottom) {
                // Touch ended over target, consider it a drop
                const selectedIndex = parseInt(touchedElement.dataset.index);
                placeImage(touchedElement, selectedIndex);
            }

            // Clean up
            if (clonedElement && clonedElement.parentNode) {
                clonedElement.parentNode.removeChild(clonedElement);
            }
            clonedElement = null;
            touchedElement = null;
        }

        // Place an image in the current target position
        function placeImage(optionElement, imageIndex) {
            const currentPlaceholder = sequenceContainer.querySelectorAll('.box-placeholder')[currentIndex];

            if (currentPlaceholder.dataset.filled === 'true') {
                return; // This placeholder is already filled
            }

            totalMoves++;

            // Check if the image is correct for this position
            if (imageIndex === currentIndex) {
                // Correct placement
                currentPlaceholder.style.backgroundImage = optionElement.style.backgroundImage;
                currentPlaceholder.dataset.filled = 'true';
                optionElement.style.visibility = 'hidden';

                // Update score and feedback
                score += 10;
                correctPlacements++;
                feedbackElement.textContent = "Correct! Keep going.";
                feedbackElement.style.color = '#4CAF50';

                // Move to next position
                currentIndex++;

                // If all positions are filled, end the game
                if (currentIndex >= sequenceContainer.querySelectorAll('.box-placeholder').length) {
                    // End with a short delay to let the user see the completed sequence
                    setTimeout(() => {
                        endGame(true);
                    }, 500);
                    return;
                }

                // Move the target box to the next position
                const nextPlaceholder = sequenceContainer.querySelectorAll('.box-placeholder')[currentIndex];
                targetBox.style.left = (nextPlaceholder.offsetLeft) + 'px';
                targetBox.style.top = (nextPlaceholder.offsetTop) + 'px';
            } else {
                // Incorrect placement
                score = Math.max(0, score - 5);
                incorrectPlacements++;

                feedbackElement.textContent = "Not quite right. Try again!";
                feedbackElement.style.color = '#f44336';
            }
        }

        // End the game and show results
        function endGame(completed) {
            gameActive = false;

            const totalTime = (Date.now() - totalStartTime) / 1000;
            const avgTime = (totalMoves > 0) ? (totalTime / totalMoves) : 0;

            document.getElementById('score').textContent = score;
            document.getElementById('total-time-result').textContent = totalTime.toFixed(2);
            document.getElementById('avg-time').textContent = avgTime.toFixed(2);
            document.getElementById('first-tap').textContent = firstTapTime ? firstTapTime.toFixed(2) : "N/A";
            document.getElementById('total-taps-result').textContent = totalTaps;
            document.getElementById('total-correct').textContent = correctPlacements;
            document.getElementById('total-incorrect').textContent = incorrectPlacements;

            document.querySelector('.container').style.display = 'none';
            resultContainer.style.display = 'block';

            // Save results to Firebase
            if (userId) {
                saveQuizResults();
                fetchPreviousAttempts();
            }
        }

        // Save quiz results to Firebase
        function saveQuizResults() {
            const totalTime = (Date.now() - totalStartTime) / 1000;
            const avgTime = (totalMoves > 0) ? (totalTime / totalMoves) : 0;

            const quizData = {
                type: "morning",
                score: score,
                totalTime: totalTime.toFixed(2),
                avgTime: avgTime.toFixed(2),
                firstTapTime: firstTapTime ? firstTapTime.toFixed(2) : "N/A",
                totalMoves: totalMoves,
                incorrectMoves: incorrectMoves,
                totalTaps: totalTaps,
                correctPlacements: correctPlacements,
                incorrectPlacements: incorrectPlacements,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Determine the correct path based on user type
            let dbPath = '';
            if (isDoctorViewingPatient) {
                dbPath = `quiz_results/${patientId}/morning`;
            } else {
                dbPath = `quiz_results/${userId}/morning`;
            }

            db.ref(`${dbPath}/${Date.now()}`).set(quizData)
                .then(() => {
                    console.log("Quiz results saved successfully");
                })
                .catch((error) => {
                    console.error("Error saving quiz results: ", error);
                });
        }

        // Fetch previous attempts
        async function fetchPreviousAttempts() {
            try {
                // Determine the path based on user type
                let path = '';
                if (isDoctorViewingPatient) {
                    path = `quiz_results/${patientId}/morning`;
                } else {
                    path = `quiz_results/${userId}/morning`;
                }

                console.log(`Fetching previous attempts from path: ${path}`);
                const resultsSnapshot = await db.ref(path).once('value');
                const reportList = document.getElementById('report-list');
                reportList.innerHTML = '';

                if (resultsSnapshot.exists()) {
                    const results = [];
                    resultsSnapshot.forEach(childSnapshot => {
                        results.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Sort by timestamp (newest first)
                    results.sort((a, b) => {
                        return b.timestamp - a.timestamp;
                    });

                    // Take only the most recent 5
                    const recentResults = results.slice(0, 5);

                    if (recentResults.length > 0) {
                        document.getElementById('report-container').style.display = 'block';
                        
                        recentResults.forEach(result => {
                            const timestamp = result.timestamp;
                            // Check if timestamp is a number (milliseconds) or a string (ISO format)
                            const date = typeof timestamp === 'number'
                                ? new Date(timestamp)
                                : new Date(timestamp);

                            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                            const li = document.createElement('li');
                            li.className = 'attempt-item';
                            
                            const dateDiv = document.createElement('div');
                            dateDiv.className = 'attempt-date';
                            dateDiv.textContent = formattedDate;
                            
                            const scoreDiv = document.createElement('div');
                            scoreDiv.className = 'attempt-score';
                            scoreDiv.textContent = `Score: ${result.score || 0}`;
                            
                            const detailsDiv = document.createElement('div');
                            detailsDiv.className = 'attempt-details';
                            
                            // Add time metrics
                            detailsDiv.innerHTML += createDetailItem('Total Time', `${result.totalTime || 0}s`);
                            detailsDiv.innerHTML += createDetailItem('Avg Time', `${result.avgTime || 0}s`);
                            detailsDiv.innerHTML += createDetailItem('First Tap', `${result.firstTapTime || 0}s`);
                            detailsDiv.innerHTML += createDetailItem('Total Taps', result.totalTaps || 0);
                            detailsDiv.innerHTML += createDetailItem('Correct', result.correctPlacements || 0);
                            detailsDiv.innerHTML += createDetailItem('Incorrect', result.incorrectPlacements || 0);
                            
                            li.appendChild(dateDiv);
                            li.appendChild(scoreDiv);
                            li.appendChild(detailsDiv);
                            reportList.appendChild(li);
                        });
                    } else {
                        reportList.innerHTML = '<p>No previous attempts found.</p>';
                    }
                } else {
                    reportList.innerHTML = '<p>No previous attempts found.</p>';
                }
            } catch (error) {
                console.error('Error fetching previous attempts:', error);
                document.getElementById('report-list').innerHTML =
                    '<p>Error loading previous attempts. Please try again later.</p>';
            }
        }

        // Helper function to create detail item for attempts list
        function createDetailItem(label, value) {
            return `
                <div class="attempt-detail-item">
                    <span class="detail-label">${label}:</span>
                    <span class="detail-value">${value}</span>
                </div>
            `;
        }

        // Clear previous attempts
        function clearReport() {
            try {
                if (!confirm('Are you sure you want to clear all previous attempts?')) {
                    return;
                }

                // Determine the path based on user type
                let path = '';
                if (isDoctorViewingPatient) {
                    path = `quiz_results/${patientId}/morning`;
                } else {
                    path = `quiz_results/${userId}/morning`;
                }

                db.ref(path).remove()
                    .then(() => {
                        document.getElementById('report-list').innerHTML = '<p>All attempts cleared.</p>';
                        console.log('Attempts cleared successfully');
                    })
                    .catch((error) => {
                        console.error('Error clearing attempts:', error);
                        alert('Error clearing attempts. Please try again.');
                    });
            } catch (error) {
                console.error('Error clearing attempts:', error);
                alert('Error clearing attempts. Please try again.');
            }
        }

        // Set profile initials helper function
        function setProfileInitials(name) {
            const nameParts = name.split(' ');
            let initials = nameParts[0].charAt(0).toUpperCase();
            
            if (nameParts.length > 1 && nameParts[1].length > 0) {
                initials += nameParts[1].charAt(0).toUpperCase();
            }
            
            document.getElementById('profileIcon').textContent = initials;
        }

        // Helper function to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Event listeners
        resetButton.addEventListener('click', initializeGame);
        
        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Images preloaded after authentication check
            images.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        });
    </script>
</body>
</html>