<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beads Activity</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }

        .pattern-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            width: 100%;
            max-width: 600px;
        }

        .statistics-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .history-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .target-colors {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }

        .pattern {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .bead {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #333;
            margin: auto;
            cursor: grab;
            transition: transform 0.2s;
        }

        .bead.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .empty-bead {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #666;
            background-color: white;
            margin: auto;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
        }

        .feedback {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        .stats {
            margin-top: 20px;
            text-align: center;
        }

        .sequence-number {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #333;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .bead-container {
            position: relative;
            width: 50px;
            height: 50px;
        }
        
        /* New styles for header and profile icon */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 650px;
        }

        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.3s;
            font-size: 16px;
        }
        
        .profile-icon:hover {
            background-color: #1976D2;
        }

        .profile-icon:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            right: 0;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-top: 5px;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            font-size: 14px;
            color: #666;
        }
        
        .patient-indicator {
            display: inline-block;
            background-color: #e9f5e9;
            color: #4CAF50;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        /* Mobile optimization */
        @media (max-width: 600px) {
            .pattern-container, .statistics-container, .options-container {
                padding: 15px;
                max-width: 450px;
            }
            
            .bead, .empty-bead {
                width: 40px;
                height: 40px;
            }
            
            .options-container {
                gap: 8px;
            }
            
            .stats-grid {
                gap: 8px;
            }
            
            .stat-item {
                padding: 8px 5px;
                font-size: 0.9rem;
            }
            
            button {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="user-info" id="userInfo"></div>
    
    <div class="header">
        <h1>Beads Pattern Building</h1>
        <div class="profile-icon" id="profileIcon" title="Back to Home" onclick="window.location.href='index.html'"></div>
    </div>
    
    <div class="pattern-container">
        <h2>Colors to Use:</h2>
        <div class="target-colors" id="target-colors">
            <!-- Target colors will be generated here -->
        </div>

        <h2>Build Your Pattern:</h2>
        <div class="pattern" id="user-pattern">
            <!-- Empty slots will be generated here -->
        </div>
    </div>

    <div class="options-container" id="options">
        <!-- Options will be generated here -->
    </div>

    <div class="feedback" id="feedback"></div>
    
    <div class="stats">
        <p>Attempts: <span id="attempts">0</span></p>
        <p>Time: <span id="time">0:00</span></p>
        <p>Total Moves: <span id="total-moves">0</span></p>
        <p>Incorrect Moves: <span id="incorrect-moves">0</span></p>
        <p>Total Taps: <span id="total-taps">0</span></p>
    </div>

    <button id="check-button">Check Pattern</button>
    <button id="reset-button">New Pattern</button>

    <div class="statistics-container">
        <h2>Current Session Statistics</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <h3>Time</h3>
                <p id="session-time">0:00</p>
            </div>
            <div class="stat-item">
                <h3>Attempts</h3>
                <p id="session-attempts">0</p>
            </div>
            <div class="stat-item">
                <h3>Total Moves</h3>
                <p id="session-total-moves">0</p>
            </div>
            <div class="stat-item">
                <h3>Incorrect Moves</h3>
                <p id="session-incorrect-moves">0</p>
            </div>
            <div class="stat-item">
                <h3>Total Taps</h3>
                <p id="session-total-taps">0</p>
            </div>
        </div>

        <h2>Recent History</h2>
        <div id="history-list" class="history-list">
            <!-- History items will be loaded here -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFENL5Z_2Cewh4p6zp_BZtxL9n0di-9u8",
            authDomain: "projeccvi.firebaseapp.com",
            projectId: "projeccvi",
            storageBucket: "projeccvi.firebasestorage.app",
            messagingSenderId: "279067566247",
            appId: "1:279067566247:web:9cf00f7bf1ea3549fabb82"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // User variables
        let currentUser = null;
        let isDoctor = false;
        let patientUid = null;
        let firstTapTime = null;

        // Check for doctor viewing patient context
        const urlParams = new URLSearchParams(window.location.search);
        const patientParam = urlParams.get('patient');
        
        // Game state variables
        let startTime = null;
        let timerInterval;
        let totalMoves = 0;
        let incorrectMoves = 0;
        let totalTaps = 0;
        let attempts = 0;
        let nextPosition = 0;
        let currentSequence = Array(12).fill(null);
        const colors = ['red', 'blue', 'green', 'yellow'];
        let availableBeads = {};

        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                
                // Set up the profile icon with user's initials
                const displayName = user.displayName || user.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                document.getElementById('profileIcon').textContent = initial;
                
                // Check if user is a doctor
                const userTypeRef = ref(db, `users/${user.uid}/userType`);
                onValue(userTypeRef, (snapshot) => {
                    isDoctor = snapshot.val() === 'doctor';
                    
                    if (isDoctor && patientParam) {
                        patientUid = patientParam;
                        // Get patient's display name
                        const patientRef = ref(db, `users/${patientParam}/displayName`);
                        onValue(patientRef, (snapshot) => {
                            const patientName = snapshot.val() || 'Patient';
                            document.getElementById('userInfo').innerHTML = `Viewing: ${patientName} <span class="patient-indicator">Patient</span>`;
                        });
                    } else {
                        document.getElementById('userInfo').textContent = `Welcome, ${displayName}`;
                    }
                    
                    // Load history for the appropriate user
                    loadHistory();
                });
                
                // Start the game
                initializeGame();
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
            }
        });

        // Track first tap time
        document.addEventListener('click', () => {
            if (firstTapTime === null) {
                firstTapTime = Date.now() - startTime;
            }
            totalTaps++;
            document.getElementById('total-taps').textContent = totalTaps;
            document.getElementById('session-total-taps').textContent = totalTaps;
        });

        // Initialize available beads
        function initializeAvailableBeads() {
            availableBeads = {};
            colors.forEach(color => {
                availableBeads[color] = 3;
            });
        }

        // Function to save attempt to Firebase
        function saveAttempt(data) {
            if (!currentUser) return;
            
            const timestamp = Date.now();
            
            // Determine the correct path based on user role
            let dbPath = '';
            if (isDoctor && patientUid) {
                dbPath = `userActivities/${patientUid}/beadsActivity/${timestamp}`;
            } else {
                dbPath = `userActivities/${currentUser.uid}/beadsActivity/${timestamp}`;
            }
            
            const attemptRef = ref(db, dbPath);
            const attemptData = {
                timestamp: timestamp,
                completionTime: data.completionTime,
                totalMoves: totalMoves,
                incorrectMoves: incorrectMoves,
                totalTaps: totalTaps,
                attempts: attempts,
                firstTapTime: firstTapTime || 0
            };
            
            set(attemptRef, attemptData)
                .then(() => {
                    console.log("Attempt saved successfully");
                    loadHistory();
                })
                .catch((error) => {
                    console.error("Error saving attempt:", error);
                });
        }

        // Function to load attempt history
        function loadHistory() {
            if (!currentUser) return;
            
            // Determine the correct path based on user role
            let dbPath = '';
            if (isDoctor && patientUid) {
                dbPath = `userActivities/${patientUid}/beadsActivity`;
            } else {
                dbPath = `userActivities/${currentUser.uid}/beadsActivity`;
            }
            
            const attemptsRef = ref(db, dbPath);
            const recentAttemptsQuery = query(attemptsRef, orderByChild('timestamp'), limitToLast(10));
            
            onValue(recentAttemptsQuery, (snapshot) => {
                if (snapshot.exists()) {
                    const historyList = document.getElementById('history-list');
                    historyList.innerHTML = '';
                    
                    const attempts = [];
                    snapshot.forEach((child) => {
                        attempts.push({
                            ...child.val(),
                            key: child.key
                        });
                    });

                    // Sort attempts by timestamp (most recent first)
                    attempts.sort((a, b) => b.timestamp - a.timestamp);

                    // Display the attempts
                    attempts.forEach((attempt) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <span>Time: ${attempt.completionTime}s</span>
                            <span>Moves: ${attempt.totalMoves}</span>
                            <span>Incorrect: ${attempt.incorrectMoves}</span>
                            <span>Taps: ${attempt.totalTaps}</span>
                        `;
                        historyList.appendChild(historyItem);
                    });
                }
            });
        }

        // Function to check pattern
        function checkPattern() {
            attempts++;
            document.getElementById('attempts').textContent = attempts;
            document.getElementById('session-attempts').textContent = attempts;
            
            if (currentSequence.includes(null)) {
                showFeedback('Please complete the pattern first!', 'red');
                return;
            }

            const colorCounts = {};
            colors.forEach(color => colorCounts[color] = 0);
            currentSequence.forEach(color => colorCounts[color]++);
            const isCorrect = colors.every(color => colorCounts[color] === 3);
            
            if (isCorrect) {
                const endTime = Date.now();
                const completionTime = ((endTime - startTime) / 1000).toFixed(2);
                
                // Save attempt to Firebase
                saveAttempt({
                    completionTime: parseFloat(completionTime)
                });

                showFeedback('Correct! Well done!', 'green');
                clearInterval(timerInterval);
            } else {
                showFeedback('Try again!', 'red');
                setTimeout(() => {
                    createUserPattern();
                }, 1500);
            }
        }

        function showFeedback(message, color) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.style.color = color;
        }

        function updateOptionsDisplay() {
            document.getElementById('total-moves').textContent = totalMoves;
            document.getElementById('incorrect-moves').textContent = incorrectMoves;
            document.getElementById('session-total-moves').textContent = totalMoves;
            document.getElementById('session-incorrect-moves').textContent = incorrectMoves;
        }

        function startTimer() {
            if (startTime === null) {
                startTime = Date.now();
            }

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const currentTime = Date.now();
                const elapsedTime = Math.floor((currentTime - startTime) / 1000);
                const minutes = Math.floor(elapsedTime / 60);
                const seconds = elapsedTime % 60;
                const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('time').textContent = formattedTime;
                document.getElementById('session-time').textContent = formattedTime;
            }, 1000);
        }

        function initializeGame() {
            // Reset game state
            startTime = null;
            totalMoves = 0;
            incorrectMoves = 0;
            totalTaps = 0;
            attempts = 0;
            firstTapTime = null;
            nextPosition = 0;
            currentSequence = Array(12).fill(null);
            
            // Reset displayed values
            document.getElementById('total-moves').textContent = totalMoves;
            document.getElementById('incorrect-moves').textContent = incorrectMoves;
            document.getElementById('total-taps').textContent = totalTaps;
            document.getElementById('attempts').textContent = attempts;
            document.getElementById('session-total-moves').textContent = totalMoves;
            document.getElementById('session-incorrect-moves').textContent = totalMoves;
            document.getElementById('session-total-taps').textContent = totalTaps;
            document.getElementById('session-attempts').textContent = attempts;
            
            // Initialize beads
            initializeAvailableBeads();
            
            // Create target color display
            createTargetColors();
            
            // Create user pattern slots
            createUserPattern();
            
            // Update options
            updateOptions();
            
            // Set up buttons
            document.getElementById('check-button').addEventListener('click', checkPattern);
            document.getElementById('reset-button').addEventListener('click', initializeGame);
            
            // Start timer
            startTimer();
        }

        function createTargetColors() {
            const targetColorsContainer = document.getElementById('target-colors');
            targetColorsContainer.innerHTML = '';
            
            colors.forEach(color => {
                const colorElement = document.createElement('div');
                colorElement.className = 'bead';
                colorElement.style.backgroundColor = color;
                targetColorsContainer.appendChild(colorElement);
            });
        }

        function createUserPattern() {
            const patternContainer = document.getElementById('user-pattern');
            patternContainer.innerHTML = '';
            currentSequence = Array(12).fill(null);
            nextPosition = 0;
            
            for (let i = 0; i < 12; i++) {
                const slot = document.createElement('div');
                slot.className = 'bead-container';
                
                const emptyBead = document.createElement('div');
                emptyBead.className = 'empty-bead';
                emptyBead.dataset.position = i;
                
                slot.appendChild(emptyBead);
                patternContainer.appendChild(slot);
            }
            
            updateOptions();
        }

        function updateOptions() {
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            // Create array of remaining beads
            const remainingBeads = [];
            Object.keys(availableBeads).forEach(color => {
                for (let i = 0; i < availableBeads[color]; i++) {
                    remainingBeads.push(color);
                }
            });
            
            // Shuffle the array
            for (let i = remainingBeads.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [remainingBeads[i], remainingBeads[j]] = [remainingBeads[j], remainingBeads[i]];
            }
            
            // Create option elements
            remainingBeads.forEach(color => {
                const bead = document.createElement('div');
                bead.className = 'bead';
                bead.style.backgroundColor = color;
                bead.dataset.color = color;
                
                bead.addEventListener('click', function() {
                    if (nextPosition < 12 && availableBeads[color] > 0) {
                        currentSequence[nextPosition] = color;
                        availableBeads[color]--;
                        
                        const slots = document.querySelectorAll('.empty-bead');
                        const slot = slots[nextPosition];
                        
                        // Replace empty slot with colored bead
                        const container = slot.parentElement;
                        container.removeChild(slot);
                        
                        const newBead = document.createElement('div');
                        newBead.className = 'bead';
                        newBead.style.backgroundColor = color;
                        newBead.dataset.position = nextPosition;
                        
                        // Add removal functionality
                        newBead.addEventListener('click', function() {
                            const position = parseInt(this.dataset.position);
                            const beadColor = currentSequence[position];
                            
                            if (beadColor) {
                                // Return the bead to available
                                availableBeads[beadColor]++;
                                currentSequence[position] = null;
                                
                                // Replace with empty slot
                                const emptyBead = document.createElement('div');
                                emptyBead.className = 'empty-bead';
                                emptyBead.dataset.position = position;
                                
                                const parent = this.parentElement;
                                parent.removeChild(this);
                                parent.appendChild(emptyBead);
                                
                                // Recalculate next position
                                for (let i = 0; i < 12; i++) {
                                    if (currentSequence[i] === null) {
                                        nextPosition = i;
                                        break;
                                    }
                                }
                                
                                updateOptions();
                                totalMoves++;
                                updateOptionsDisplay();
                            }
                        });
                        
                        container.appendChild(newBead);
                        
                        // Update next position
                        nextPosition++;
                        while (nextPosition < 12 && currentSequence[nextPosition] !== null) {
                            nextPosition++;
                        }
                        
                        updateOptions();
                        totalMoves++;
                        updateOptionsDisplay();
                    } else if (availableBeads[color] === 0) {
                        showFeedback('No more ' + color + ' beads available!', 'red');
                        incorrectMoves++;
                        updateOptionsDisplay();
                    } else {
                        showFeedback('Pattern is full!', 'red');
                        incorrectMoves++;
                        updateOptionsDisplay();
                    }
                });
                
                optionsContainer.appendChild(bead);
            });
        }

        // Initialize the game on load
        if (auth.currentUser) {
            initializeGame();
        }
    </script>
</body>
</html>