<!DOCTYPE html>
<html>
<head>
    <title>Visual Discrimination Quiz</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Your existing styles */
        #loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        #error-message {
            display: none;
            background-color: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="error-message"></div>
    <div id="quiz-container" style="display: none;">
        <h1>Visual Perceptual Skills</h1>
        <h2>Select a Quiz Type:</h2>
        <br>
        <!-- Quiz Type Selection -->
        <div id="quiz-type">
            <a href="VDT.html" style="text-decoration: none;"><button onclick="startQuiz('animals')">Shape Exercise</button></a>
            <a href="VDTS1.html" style="text-decoration: none;"><button onclick="VD.html">Size Exercise</button></a>
            <a href="VDTSE1.html" style="text-decoration: none;"><button onclick="startQuiz('colors')">Emotion Exercise</button></a>
            <a href="VDTCC1.html" style="text-decoration: none;"><button onclick="startQuiz('colors')">Colour Exercise</button></a>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFENL5Z_2Cewh4p6zp_BZtxL9n0di-9u8",
            authDomain: "projeccvi.firebaseapp.com",
            projectId: "projeccvi",
            storageBucket: "projeccvi.appspot.com",
            messagingSenderId: "279067566247",
            appId: "1:279067566247:web:9cf00f7bf1ea3549fabb82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Show/hide loading
        function showLoading(show, message = 'Loading...') {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.textContent = message;
                loadingDiv.style.display = show ? 'block' : 'none';
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            showLoading(true);
            if (user) {
                try {
                    // Get user profile
                    const profileRef = database.ref(`userProfiles/${user.uid}`);
                    const profileSnap = await profileRef.once('value');
                    const userProfile = profileSnap.val();

                    if (!userProfile) {
                        window.location.href = 'profile.html';
                        return;
                    }

                    // Show quiz container
                    document.getElementById('quiz-container').style.display = 'block';
                    
                    // Store quiz context
                    window.quizContext = {
                        userId: user.uid,
                        isPatientQuiz: localStorage.getItem('isPatientQuiz') === 'true',
                        currentPatientId: localStorage.getItem('currentPatientId'),
                        isDoctor: userProfile.isDoctor
                    };

                    // Initialize quiz
                    initializeQuiz();
                } catch (error) {
                    console.error('Error loading profile:', error);
                    showError('Failed to load profile. Please try again.');
                }
            } else {
                window.location.href = 'login.html';
            }
            showLoading(false);
        });

        // Save quiz results
        async function saveQuizResults(results) {
            try {
                const { userId, isPatientQuiz, currentPatientId } = window.quizContext;
                
                let resultsRef;
                if (isPatientQuiz && currentPatientId) {
                    resultsRef = database.ref(`doctors/${userId}/patients/${currentPatientId}/quizResults`);
                } else {
                    resultsRef = database.ref(`userProfiles/${userId}/quizResults`);
                }

                const quizData = {
                    type: 'Visual Discrimination',
                    score: results.score,
                    totalTime: results.totalTime,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    answers: results.answers
                };

                await resultsRef.push(quizData);
                console.log('Quiz results saved successfully');
            } catch (error) {
                console.error('Error saving results:', error);
                showError('Failed to save quiz results. Please try again.');
            }
        }
    </script>

    <!-- Your existing quiz scripts -->
    <script src="script.js"></script>
    <script src="auth.js"></script>
</body>
</html>