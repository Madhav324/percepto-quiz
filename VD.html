<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Perceptual Skills</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="quiz-container">
        <h1>Visual Perceptual Skills</h1>
        <h2>Select a Quiz Type:</h2>
<br>
        <!-- Quiz Type Selection -->
        <div id="quiz-type">
            <a href="VDT.html" style="text-decoration: none;"><button onclick="startQuiz('animals')">Shape Exercise</button></a>
            <a href="VDTS1.html" style="text-decoration: none;"><button onclick="VD.html">Size Exercise</button></a>
            <a href="VDTSE1.html" style="text-decoration: none;"><button onclick="startQuiz('colors')">Emotion Exercise</button></a>
            <a href="VDTCC1.html" style="text-decoration: none;"><button onclick="startQuiz('colors')">Colour Exercise</button></a>
        </div>

    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDFENL5Z_2Cewh4p6zp_BZtxL9n0di-9u8",
            authDomain: "projeccvi.firebaseapp.com",
            projectId: "projeccvi",
            storageBucket: "projeccvi.appspot.com",
            messagingSenderId: "279067566247",
            appId: "1:279067566247:web:9cf00f7bf1ea3549fabb82"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <!-- Auth Helper -->
    <script src="auth.js"></script>

    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading(true, 'Loading quiz...');
                const authData = await checkAuth();
                const { user, isDoctor, currentPatientId, isPatientQuiz } = authData;

                // Store quiz context for saving results
                window.quizContext = {
                    userId: user.uid,
                    isPatientQuiz,
                    currentPatientId,
                    isDoctor
                };

                // Initialize quiz after auth check
                initializeQuiz();
            } catch (error) {
                console.error('Auth error:', error);
                showError('Authentication failed. Please login again.');
                window.location.href = 'login.html';
            } finally {
                showLoading(false);
            }
        });

        // Save quiz results with proper context
        async function saveQuizResults(results) {
            try {
                const { userId, isPatientQuiz, currentPatientId } = window.quizContext;
                
                // Determine where to save results
                let resultsRef;
                if (isPatientQuiz && currentPatientId) {
                    resultsRef = firebase.database().ref(`doctors/${userId}/patients/${currentPatientId}/quizResults`);
                } else {
                    resultsRef = firebase.database().ref(`userProfiles/${userId}/quizResults`);
                }

                // Add quiz results
                const quizData = {
                    type: 'Visual Discrimination',
                    score: results.score,
                    totalTime: results.totalTime,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    answers: results.answers
                };

                await resultsRef.push(quizData);
                console.log('Quiz results saved successfully');
            } catch (error) {
                console.error('Error saving results:', error);
                showError('Failed to save quiz results. Please try again.');
            }
        }
    </script>

    <script src="script.js"></script>
</body>
</html>