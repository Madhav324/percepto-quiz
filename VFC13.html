<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Perceptual Skills</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2px;
            font-size: 10px;
        }

        #quiz-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 4px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            width: 100%;
        }

        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.3s;
            font-size: 16px;
        }
        
        .profile-icon:hover {
            background-color: #1976D2;
        }

        .profile-icon:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            right: 0;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-top: 5px;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
            font-size: 12px;
            color: #666;
        }
        
        .patient-indicator {
            display: inline-block;
            background-color: #e9f5e9;
            color: #4CAF50;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }

        .question {
            text-align: center;
            width: 100%;
            margin-bottom: 5px;
        }

        .question h1 {
            font-size: 14px;
            margin: 0 0 4px 0;
            font-weight: normal;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            width: 100%;
            max-width: 350px;
            margin: 0 auto 5px auto;
            padding: 2px;
            box-sizing: border-box;
        }

        .grid-item {
            aspect-ratio: 1;
            border: 1px solid #ddd;
            border-radius: 2px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2px;
            box-sizing: border-box;
        }

        .grid-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            padding: 2px;
            box-sizing: border-box;
            grid-auto-flow: dense;
            grid-auto-rows: min-content;
        }

        .option {
            aspect-ratio: 1;
            border: 1px solid #ddd;
            border-radius: 2px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2px;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.15s ease-out;
            transform-origin: center top;
            margin-bottom: 0;
            touch-action: none; /* Prevent browser handling of touch events */
        }

        .option img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .option:hover {
            border-color: #4CAF50;
            transform: scale(1.02);
        }

        .option.hidden {
            display: none;
        }

        .option.moving-up {
            transform: translateY(-100%);
            opacity: 0;
        }

        .feedback {
            text-align: center;
            margin: 4px 0;
            font-size: 12px;
            font-weight: bold;
            min-height: 16px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 6px 12px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .feedback.visible {
            opacity: 1;
        }

        #result-container {
            display: none;
            width: 100%;
            max-width: 300px;
            margin: 5px auto;
            padding: 5px;
            background-color: white;
            border-radius: 2px;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #result-container h2 {
            font-size: 12px;
            margin: 0 0 4px 0;
            text-align: center;
        }

        #result-container ul {
            margin: 0;
            padding: 0;
            list-style-type: none;
            text-align: center;
        }

        #result-container li {
            margin-bottom: 2px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }

        #result-container li span {
            font-weight: bold;
        }

        #result-container .home-button {
            margin-top: 8px;
            display: block;
            width: 100%;
        }

        #report-container {
            width: 100%;
            max-width: 350px;
            margin: 5px auto;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        #report-container h2 {
            font-size: 12px;
            margin: 0 0 4px 0;
        }

        #report-list {
            width: 100%;
            padding: 0;
            margin: 0;
            list-style-type: none;
        }

        .attempt-item {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-size: 10px;
        }
        
        .attempt-item:hover {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        
        .attempt-date {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            font-size: 11px;
        }
        
        .attempt-score {
            color: #4CAF50;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .attempt-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 9px;
        }

        button {
            padding: 4px 8px;
            margin: 3px;
            border: none;
            background-color: #4CAF50;
            color: white;
            font-size: 10px;
            cursor: pointer;
            border-radius: 2px;
            transition: background-color 0.15s;
        }

        button:hover {
            background-color: #45a049;
        }

        .hidden {
            display: none;
        }

        #history-container {
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            padding: 5px;
            background-color: white;
            border-radius: 2px;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none;
        }

        #history-container h3 {
            font-size: 11px;
            margin: 0 0 4px 0;
            text-align: center;
        }

        .history-item {
            border-bottom: 1px solid #eee;
            padding: 4px 0;
            font-size: 9px;
            margin-bottom: 5px;
        }

        .history-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .history-item .timestamp {
            color: #666;
            font-size: 8px;
            margin-bottom: 2px;
        }

        .history-stats {
            text-align: left;
            padding: 0 10px;
        }

        .history-stats div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1px;
        }

        .history-stats span {
            font-weight: bold;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="quiz-container">
        <div class="header">
            <h1>Form Constancy Exercise</h1>
            <div class="profile-icon" id="profileIcon" title="Back to Home" onclick="window.location.href='index.html'"></div>
            <div class="user-info">
                <span id="patient-indicator" class="patient-indicator"></span>
            </div>
        </div>
        <div class="question">
            <h1>Place the options in their correct positions</h1>
        </div>
        <div class="grid-container">
            <div class="grid-item" data-answer="1"><img src="images/VFC/lvl1/size/1a.png"></div>
            <div class="grid-item" data-answer="2"><img src="images/VFC/lvl1/size/2a.png"></div>
            <div class="grid-item" data-answer="3"><img src="images/VFC/lvl1/size/3a.png"></div>
            <div class="grid-item" data-answer="4"><img src="images/VFC/lvl1/size/4a.png"></div>
            <div class="grid-item" data-answer="5"></div>
            <div class="grid-item" data-answer="6"></div>
            <div class="grid-item" data-answer="7"></div>
            <div class="grid-item" data-answer="8"></div>
            <div class="grid-item" data-answer="9"></div>
            <div class="grid-item" data-answer="10"></div>
            <div class="grid-item" data-answer="11"></div>
            <div class="grid-item" data-answer="12"></div>
            <div class="grid-item" data-answer="13"></div>
            <div class="grid-item" data-answer="14"></div>
            <div class="grid-item" data-answer="15"></div>
            <div class="grid-item" data-answer="16"></div>
        </div>

        <div class="options">
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/1b.png" alt="Image 1" id="drag5" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/2b.png" alt="Image 2" id="drag6" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/3b.png" alt="Image 3" id="drag7" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/4b.png" alt="Image 4" id="drag8" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/1c.png" alt="Image 1" id="drag9" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/2c.png" alt="Image 2" id="drag10" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/3c.png" alt="Image 3" id="drag11" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/4c.png" alt="Image 4" id="drag12" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/1d.png" alt="Image 1" id="drag13" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/2d.png" alt="Image 2" id="drag14" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/3d.png" alt="Image 3" id="drag15" />
            </div>
            <div class="option" draggable="true">
                <img src="images/VFC/lvl1/size/4d.png" alt="Image 4" id="drag16" />
            </div>
        </div>

        <div class="feedback" id="feedback"></div>

        <button id="submitBtn">Submit</button>

        <div id="result-container" style="display: none;">
            <h2>Your Results</h2>
            <ul>
                <li><div>Score:</div><div><span id="score">0</span></div></li>
                <li><div>Total Time:</div><div><span id="total-time">0</span>s</div></li>
                <li><div>Average Time:</div><div><span id="avg-time">0</span>s</div></li>
                <li><div>First Tap:</div><div><span id="first-tap">0</span>s</div></li>
                <li><div>Total Taps:</div><div><span id="total-taps">0</span></div></li>
                <li><div>Total Correct:</div><div><span id="total-correct">0</span></div></li>
                <li><div>Total Incorrect:</div><div><span id="total-incorrect">0</span></div></li>
            </ul>
            <button onclick="window.location.href='index.html'" class="home-button">Return Home</button>
        </div>
        <div id="report-container">
            <h2>All Quiz Attempts</h2>
            <ul id="report-list"></ul>
            <button id="clear-report" onclick="clearReport()">Clear Report</button>
        </div>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDFENL5Z_2Cewh4p6zp_BZtxL9n0di-9u8",
                authDomain: "projeccvi.firebaseapp.com",
                projectId: "projeccvi",
                storageBucket: "projeccvi.appspot.com",
                messagingSenderId: "279067566247",
                appId: "1:279067566247:web:9cf00f7bf1ea3549fabb82"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();
            
            // Get quiz context from session storage
            const currentPatientId = sessionStorage.getItem('currentPatientId');
            const doctorId = sessionStorage.getItem('doctorId');
            const isPatientQuiz = !!currentPatientId;
            
            console.log('Quiz context in VFC13:', { 
                isPatientQuiz, 
                currentPatientId: currentPatientId || 'none',
                doctorId: doctorId || 'none'
            });

            // Auth state observer
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated in VFC13:', user.uid);
                    
                    try {
                        // Check if user is a doctor
                        if (!isPatientQuiz) {
                            const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                            const role = roleSnapshot.val();
                            
                            if (role === 'doctor') {
                                console.log('Doctor detected without patient context, redirecting');
                                // Redirect doctors without patient context back to index
                                alert('Please select a patient first to administer the quiz.');
                                window.location.href = 'index.html';
                                return;
                            }
                        }
                        
                        // Load user profile
                        let profile;
                        if (isPatientQuiz) {
                            // Doctor viewing patient
                            console.log(`Loading patient profile in VFC13: ${currentPatientId}`);
                            const patientSnapshot = await database.ref(`doctors/${doctorId}/patients/${currentPatientId}/profile`).once('value');
                            profile = patientSnapshot.val();
                        } else {
                            // Regular user
                            console.log('Loading user profile in VFC13');
                            const userSnapshot = await database.ref(`users/${user.uid}/profile`).once('value');
                            profile = userSnapshot.val();
                        }
                        
                        // Get first letter of name or email
                        let initial = 'U';
                        if (profile && profile.name) {
                            initial = profile.name.charAt(0).toUpperCase();
                        } else if (user.email) {
                            initial = user.email.charAt(0).toUpperCase();
                        }
                        
                        // Display patient indicator
                        if (isPatientQuiz) {
                            const patientIndicator = document.getElementById('patient-indicator');
                            patientIndicator.textContent = 'Patient';
                            patientIndicator.style.display = 'inline-block';
                        } else {
                            const patientIndicator = document.getElementById('patient-indicator');
                            patientIndicator.style.display = 'none';
                        }
                        
                        document.getElementById('profileIcon').textContent = initial;
                    } catch (error) {
                        console.error('Error loading profile in VFC13:', error);
                        document.getElementById('profileIcon').textContent = 'U';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });

            const optionContainers = document.querySelectorAll('.option');
            const gridItems = document.querySelectorAll('.grid-item');
            const feedback = document.getElementById('feedback');
            const submitButton = document.getElementById('submitBtn');

            let startTime = null;
            let totalStartTime = null;
            let firstTapTime = null;
            let totalTaps = 0;
            let totalIncorrectAttempts = 0;
            let filledGrids = 0;
            let firstInteractionRecorded = false;
            const totalGrids = gridItems.length - 4; // Subtract pre-filled grid items
            
            // Touch event variables
            let touchDragging = false;
            let touchDragElement = null;
            let touchDragStartX, touchDragStartY;
            let touchDragOffsetX, touchDragOffsetY;
            let ghostElement = null;

            // Track first drag start
            document.addEventListener('dragstart', () => {
                totalTaps++;
                
                // Record first interaction time
                if (!firstInteractionRecorded && totalStartTime) {
                    firstInteractionRecorded = true;
                    firstTapTime = (Date.now() - totalStartTime) / 1000;
                    document.getElementById('first-tap').textContent = firstTapTime.toFixed(2);
                    console.log("First tap time recorded (drag):", firstTapTime);
                }
            });

            optionContainers.forEach(option => {
                option.addEventListener('dragstart', dragStart);
                option.addEventListener('dragend', dragEnd);
                
                // Add touch events for mobile
                option.addEventListener('touchstart', touchStart, { passive: false });
                option.addEventListener('touchmove', touchMove, { passive: false });
                option.addEventListener('touchend', touchEnd);
                option.addEventListener('touchcancel', touchEnd);
            });

            gridItems.forEach(gridItem => {
                gridItem.addEventListener('dragover', dragOver);
                gridItem.addEventListener('drop', drop);
            });

            function dragStart(e) {
                if (!startTime) startTime = Date.now();
                let target = e.target;
                
                // If target is not option container itself, find it
                if (!target.classList.contains('option')) {
                    target = target.closest('.option');
                }
                
                // Find the image inside the option
                const dragImg = target.querySelector('img');
                if (dragImg) {
                    e.dataTransfer.setData('text', dragImg.id);
                    e.dataTransfer.setData('optionid', target.id);
                    e.dataTransfer.setData('parent', 'true');
                    
                    // Use a timeout to ensure the drag image is set before adding the dragging class
                    setTimeout(() => {
                        target.classList.add('dragging');
                    }, 0);
                }
            }

            function dragEnd(e) {
                let target = e.target;
                if (!target.classList.contains('option')) {
                    target = target.closest('.option');
                }
                target.classList.remove('dragging');
            }

            function dragOver(e) {
                e.preventDefault();
            }

            function drop(e) {
                e.preventDefault();
                const draggedId = e.dataTransfer.getData('text');
                const isParent = e.dataTransfer.getData('parent') === 'true';
                
                let draggedElement;
                let optionElement;
                
                if (isParent) {
                    // Get image and option elements
                    draggedElement = document.getElementById(draggedId);
                    optionElement = draggedElement ? draggedElement.closest('.option') : null;
                } else {
                    // Just get the image element
                    draggedElement = document.getElementById(draggedId);
                    optionElement = draggedElement ? draggedElement.parentElement : null;
                }
                
                if (optionElement) {
                    handleDrop(optionElement, e.target);
                }
            }
            
            // Touch event handlers
            function touchStart(e) {
                e.preventDefault();
                if (!startTime) startTime = Date.now();
                
                // Record interaction
                totalTaps++;
                
                // Record first interaction time
                if (!firstInteractionRecorded && totalStartTime) {
                    firstInteractionRecorded = true;
                    firstTapTime = (Date.now() - totalStartTime) / 1000;
                    document.getElementById('first-tap').textContent = firstTapTime.toFixed(2);
                    console.log("First tap time recorded (touch):", firstTapTime);
                }
                
                // Get touch coordinates
                const touch = e.touches[0];
                let target = e.target;
                
                // If target is not an option container, find the container
                if (!target.classList.contains('option')) {
                    target = target.closest('.option');
                }
                
                if (!target) return;
                
                if (target.classList.contains('hidden') || target.classList.contains('moving-up')) {
                    return;
                }
                
                touchDragging = true;
                touchDragElement = target;
                
                // Calculate offset from touch point to element's top-left corner
                const rect = target.getBoundingClientRect();
                touchDragOffsetX = touch.clientX - rect.left;
                touchDragOffsetY = touch.clientY - rect.top;
                touchDragStartX = touch.clientX;
                touchDragStartY = touch.clientY;
                
                // Create ghost element for visual feedback
                ghostElement = target.cloneNode(true);
                const img = target.querySelector('img');
                if (img) {
                    ghostElement.id = 'ghost-' + img.id;
                } else {
                    ghostElement.id = 'ghost-element';
                }
                ghostElement.style.position = 'fixed';
                ghostElement.style.left = rect.left + 'px';
                ghostElement.style.top = rect.top + 'px';
                ghostElement.style.width = rect.width + 'px';
                ghostElement.style.height = rect.height + 'px';
                ghostElement.style.opacity = '0.8';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.pointerEvents = 'none';
                document.body.appendChild(ghostElement);
                
                // Apply subtle highlight to original element
                target.style.opacity = '0.4';
            }

            function touchMove(e) {
                if (!touchDragging || !touchDragElement || !ghostElement) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                
                // Move ghost element
                ghostElement.style.left = (touch.clientX - touchDragOffsetX) + 'px';
                ghostElement.style.top = (touch.clientY - touchDragOffsetY) + 'px';
            }

            function touchEnd(e) {
                if (!touchDragging || !touchDragElement || !ghostElement) return;
                e.preventDefault();
                
                // Remove ghost element
                document.body.removeChild(ghostElement);
                ghostElement = null;
                
                // Reset original element
                touchDragElement.style.opacity = '1';
                
                // Find the grid item underneath
                const touch = e.changedTouches ? e.changedTouches[0] : null;
                if (touch) {
                    const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (elementAtPoint) {
                        handleDrop(touchDragElement, elementAtPoint);
                    }
                }
                
                touchDragging = false;
                touchDragElement = null;
            }
            
            // Common function to handle both touch and mouse drop
            function handleDrop(draggedElement, targetElement) {
                const gridItem = targetElement.closest('.grid-item');
                if (!gridItem || gridItem.querySelector('img')) return;
                
                const correctAnswer = gridItem.getAttribute('data-answer');
                const dragImgElement = draggedElement.querySelector('img');
                if (!dragImgElement) return;
                
                const draggedId = dragImgElement.id;
                const draggedAnswer = draggedId.replace('drag', '');
                
                if (correctAnswer === draggedAnswer) {
                    // Create a new image element for the grid
                    const newImg = document.createElement('img');
                    newImg.src = dragImgElement.src;
                    newImg.alt = dragImgElement.alt;
                    
                    // Add the new image to the grid
                    gridItem.appendChild(newImg);
                    
                    // Animate the option moving up
                    draggedElement.classList.add('moving-up');
                    
                    setTimeout(() => {
                        // Hide the original option container
                        draggedElement.classList.add('hidden');
                        
                        // Rearrange remaining options with animation
                        rearrangeOptions();
                    }, 300);
                    
                    // Show feedback
                    feedback.textContent = "Correct!";
                    feedback.style.color = "green";
                    feedback.classList.add('visible');
                    
                    // Hide feedback after a short time
                    setTimeout(() => {
                        feedback.classList.remove('visible');
                    }, 800);
                    
                    filledGrids++;
                    
                    // Update display for correct answers
                    document.getElementById('total-correct').textContent = filledGrids;
                    
                    // If all grids are filled, automatically finalize results
                    if (filledGrids === totalGrids) {
                        finalizeResults();
                    }
                } else {
                    totalIncorrectAttempts++;
                    
                    // Show feedback
                    feedback.textContent = "Incorrect!";
                    feedback.style.color = "red";
                    feedback.classList.add('visible');
                    
                    // Hide feedback after a short time
                    setTimeout(() => {
                        feedback.classList.remove('visible');
                    }, 800);
                    
                    // Update display for incorrect answers
                    document.getElementById('total-incorrect').textContent = totalIncorrectAttempts;
                }
                
                // Update total taps display
                document.getElementById('total-taps').textContent = totalTaps;
            }

            // Function to finalize results
            function finalizeResults() {
                const totalPlacementTime = (Date.now() - startTime) / 1000;
                
                // Format results for display
                const results = {
                    score: filledGrids,
                    totalTime: totalPlacementTime.toFixed(2),
                    avgTime: (totalPlacementTime / totalGrids).toFixed(2),
                    firstTap: firstTapTime ? firstTapTime.toFixed(2) : '0',
                    totalTaps,
                    totalCorrect: filledGrids,
                    totalIncorrect: totalIncorrectAttempts
                };

                // Update display
                document.getElementById('score').textContent = results.score;
                document.getElementById('total-time').textContent = results.totalTime;
                document.getElementById('avg-time').textContent = results.avgTime;
                document.getElementById('first-tap').textContent = results.firstTap;
                document.getElementById('total-taps').textContent = results.totalTaps;
                document.getElementById('total-correct').textContent = results.totalCorrect;
                document.getElementById('total-incorrect').textContent = results.totalIncorrect;

                // Save quiz results with proper path
                saveQuizResults(
                    results.score, 
                    parseFloat(results.totalTime), 
                    parseFloat(results.avgTime), 
                    parseFloat(results.firstTap), 
                    results.totalTaps, 
                    results.totalCorrect, 
                    results.totalIncorrect
                );

                // Show results and disable submit button
                submitButton.disabled = true;
                document.getElementById('result-container').style.display = 'block';
                document.getElementById('report-container').style.display = 'flex';
                
                // Fetch previous attempts
                fetchPreviousAttempts();
            }

            // Fetch previous quiz attempts
            async function fetchPreviousAttempts() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;
                    
                    let path;
                    const reportList = document.getElementById('report-list');
                    reportList.innerHTML = '<h3>Previous Attempts</h3>';
                    
                    // Check if this is a patient quiz (doctor viewing patient)
                    const currentPatientId = sessionStorage.getItem('currentPatientId');
                    const doctorId = sessionStorage.getItem('doctorId');
                    
                    if (currentPatientId && doctorId) {
                        // This is a doctor testing a patient
                        console.log(`Fetching patient quiz results - Doctor: ${doctorId}, Patient: ${currentPatientId}`);
                        path = `doctors/${doctorId}/patients/${currentPatientId}/quiz/VFC13`;
                    } else {
                        // Regular user quiz
                        // Check if user is a doctor
                        const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                        const role = roleSnapshot.val();
                        
                        if (role === 'doctor') {
                            console.log(`Fetching doctor's own quiz results: ${user.uid}`);
                            path = `doctors/${user.uid}/quiz/VFC13`;
                        } else {
                            console.log(`Fetching regular user quiz results: ${user.uid}`);
                            path = `users/${user.uid}/quiz/VFC13`;
                        }
                    }
                    
                    console.log(`Fetching previous attempts from path: ${path}`);
                    const resultsSnapshot = await database.ref(path).once('value');
                    
                    if (resultsSnapshot.exists()) {
                        const results = [];
                        resultsSnapshot.forEach(childSnapshot => {
                            results.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // Sort by timestamp if available (newest first)
                        results.sort((a, b) => {
                            return b.timestamp - a.timestamp;
                        });
                        
                        // Take only the most recent 5
                        const recentResults = results.slice(0, 5);
                        
                        if (recentResults.length > 0) {
                            recentResults.forEach(result => {
                                const timestamp = result.timestamp;
                                // Check if timestamp is a number (milliseconds) or a string (ISO format)
                                const date = typeof timestamp === 'number' 
                                    ? new Date(timestamp) 
                                    : new Date(timestamp);
                                    
                                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                                
                                const attemptItem = document.createElement('div');
                                attemptItem.className = 'attempt-item';
                                
                                // Create main display with date and score
                                const dateScoreDiv = document.createElement('div');
                                dateScoreDiv.innerHTML = `
                                    <div class="attempt-date">${formattedDate}</div>
                                    <div class="attempt-score">Score: ${result.score}/${totalGrids}</div>
                                `;
                                attemptItem.appendChild(dateScoreDiv);
                                
                                // Create the details section
                                const detailsDiv = document.createElement('div');
                                detailsDiv.className = 'attempt-details';
                                
                                // Always show these fields
                                const detailsHtml = `
                                    <div class="attempt-detail-item">
                                        <span class="detail-label">Total Time:</span>
                                        <span>${result.totalTime || 'N/A'}s</span>
                                    </div>
                                    <div class="attempt-detail-item">
                                        <span class="detail-label">Avg Time:</span>
                                        <span>${result.averageTime || 'N/A'}s</span>
                                    </div>
                                    <div class="attempt-detail-item">
                                        <span class="detail-label">First Tap:</span>
                                        <span>${result.firstTapTime ? result.firstTapTime.toFixed(2) + 's' : 'N/A'}</span>
                                    </div>
                                    <div class="attempt-detail-item">
                                        <span class="detail-label">Total Taps:</span>
                                        <span>${result.totalTaps || 'N/A'}</span>
                                    </div>
                                    <div class="attempt-detail-item">
                                        <span class="detail-label">Correct:</span>
                                        <span>${result.correctAnswers || result.score || 'N/A'}</span>
                                    </div>
                                    <div class="attempt-detail-item">
                                        <span class="detail-label">Incorrect:</span>
                                        <span>${result.incorrectAnswers || 'N/A'}</span>
                                    </div>
                                `;
                                detailsDiv.innerHTML = detailsHtml;
                                attemptItem.appendChild(detailsDiv);
                                
                                // Add a button to toggle details
                                const toggleBtn = document.createElement('button');
                                toggleBtn.className = 'toggle-details-btn';
                                toggleBtn.textContent = 'Show Details';
                                toggleBtn.onclick = function() {
                                    if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
                                        detailsDiv.style.display = 'grid';
                                        this.textContent = 'Hide Details';
                                    } else {
                                        detailsDiv.style.display = 'none';
                                        this.textContent = 'Show Details';
                                    }
                                };
                                dateScoreDiv.appendChild(toggleBtn);
                                
                                // Initially hide details
                                detailsDiv.style.display = 'none';
                                
                                reportList.appendChild(attemptItem);
                            });
                        } else {
                            reportList.innerHTML += '<p>No previous attempts found.</p>';
                        }
                    } else {
                        reportList.innerHTML += '<p>No previous attempts found.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching previous attempts:', error);
                    document.getElementById('report-list').innerHTML += '<p>Error loading previous attempts: ' + error.message + '</p>';
                }
            }

            async function saveQuizResults(score, totalTime, averageTime, firstTapTime, totalTaps, correctAnswers, incorrectAnswers) {
                const user = auth.currentUser;
                if (!user) return;

                try {
                    const timestamp = Date.now();
                    let path;

                    // Check if this is a patient quiz (doctor viewing patient)
                    const currentPatientId = sessionStorage.getItem('currentPatientId');
                    const doctorId = sessionStorage.getItem('doctorId');
                    
                    if (currentPatientId && doctorId) {
                        // This is a doctor testing a patient
                        console.log(`Saving patient quiz results - Doctor: ${doctorId}, Patient: ${currentPatientId}`);
                        path = `doctors/${doctorId}/patients/${currentPatientId}/quiz/VFC13/${timestamp}`;
                    } else {
                        // Regular user quiz
                        // Check if user is a doctor
                        const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                        const role = roleSnapshot.val();
                        
                        if (role === 'doctor') {
                            console.log(`Saving doctor's own quiz results: ${user.uid}`);
                            path = `doctors/${user.uid}/quiz/VFC13/${timestamp}`;
                        } else {
                            console.log(`Saving regular user quiz results: ${user.uid}`);
                            path = `users/${user.uid}/quiz/VFC13/${timestamp}`;
                        }
                    }

                    console.log(`Saving quiz results to path: ${path}`);
                    await database.ref(path).set({
                        score,
                        totalTime,
                        averageTime,
                        firstTapTime,
                        totalTaps,
                        correctAnswers,
                        incorrectAnswers,
                        timestamp
                    });
                    
                    console.log('Quiz results saved successfully');
                } catch (error) {
                    console.error('Error saving quiz results:', error);
                }
            }

            async function clearReport() {
                const user = auth.currentUser;
                if (!user) {
                    alert('You need to be logged in to clear the report.');
                    return;
                }

                try {
                    let path;
                    
                    // Check if this is a patient quiz (doctor viewing patient)
                    const currentPatientId = sessionStorage.getItem('currentPatientId');
                    const doctorId = sessionStorage.getItem('doctorId');
                    
                    if (currentPatientId && doctorId) {
                        // This is a doctor testing a patient
                        console.log(`Clearing patient quiz results - Doctor: ${doctorId}, Patient: ${currentPatientId}`);
                        path = `doctors/${doctorId}/patients/${currentPatientId}/quiz/VFC13`;
                    } else {
                        // Regular user quiz
                        // Check if user is a doctor
                        const roleSnapshot = await database.ref(`roles/${user.uid}`).once('value');
                        const role = roleSnapshot.val();
                        
                        if (role === 'doctor') {
                            console.log(`Clearing doctor's own quiz results: ${user.uid}`);
                            path = `doctors/${user.uid}/quiz/VFC13`;
                        } else {
                            console.log(`Clearing regular user quiz results: ${user.uid}`);
                            path = `users/${user.uid}/quiz/VFC13`;
                        }
                    }
                    
                    console.log(`Removing all quiz results from path: ${path}`);
                    
                    // Remove all data at the specified path
                    await database.ref(path).remove();
                    
                    // Reset the results display
                    document.getElementById('report-list').innerHTML = '<h3>Previous Attempts</h3><p>No previous attempts found.</p>';
                    
                    alert('All quiz reports have been cleared successfully.');
                    
                } catch (error) {
                    console.error('Error clearing report:', error);
                    alert('Failed to clear the report: ' + error.message);
                }
            }

            // Function to rearrange remaining options
            function rearrangeOptions() {
                const optionsContainer = document.querySelector('.options');
                let visibleOptions = Array.from(document.querySelectorAll('.option')).filter(opt => 
                    !opt.classList.contains('hidden') && !opt.classList.contains('moving-up')
                );

                if (visibleOptions.length === 0) return;

                // Remove all options from container
                visibleOptions.forEach(opt => {
                    opt.style.transition = 'none';
                    optionsContainer.removeChild(opt);
                });
                
                // Shuffle visible options
                shuffleArray(visibleOptions);
                
                // Add them back in shuffled order, starting from the top
                visibleOptions.forEach((opt, index) => {
                    // Reset styles
                    opt.style.opacity = '0';
                    opt.style.transform = 'translateY(-20px)';
                    opt.style.gridRow = Math.floor(index / 4) + 1; // Force row position
                    opt.style.gridColumn = (index % 4) + 1; // Force column position
                    optionsContainer.appendChild(opt);
                    
                    // Force reflow
                    opt.offsetHeight;
                    
                    // Add animation back
                    opt.style.transition = 'all 0.3s ease-out';
                    
                    // Animate in with delay based on position
                    setTimeout(() => {
                        opt.style.opacity = '1';
                        opt.style.transform = 'translateY(0)';
                    }, index * 50);
                });
            }

            // Function to shuffle array
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Initialize statistics display
            document.addEventListener('DOMContentLoaded', () => {
                // Reset all statistics
                document.getElementById('score').textContent = '0';
                document.getElementById('total-time').textContent = '0';
                document.getElementById('avg-time').textContent = '0';
                document.getElementById('first-tap').textContent = '0';
                document.getElementById('total-taps').textContent = '0';
                document.getElementById('total-correct').textContent = '0';
                document.getElementById('total-incorrect').textContent = '0';
                
                // Get patient name if in doctor mode
                const patientIndicator = document.getElementById('patient-indicator');
                if (patientName) {
                    patientIndicator.textContent = `Patient: ${patientName}`;
                    patientIndicator.style.display = 'inline-block';
                } else {
                    patientIndicator.style.display = 'none';
                }
                
                // Initialize profile icon
                const profileIcon = document.getElementById('profileIcon');
                if (currentUser) {
                    const initials = getUserInitials(currentUser.email || 'User');
                    profileIcon.textContent = initials;
                }
                
                // Set start time
                startTime = null; // Will be set on first interaction
                totalStartTime = Date.now();
                firstInteractionRecorded = false;
                console.log("Quiz started at:", totalStartTime);
                
                // Fetch previous attempts
                fetchPreviousAttempts();
                
                // Initial shuffle of options
                setTimeout(() => {
                    rearrangeOptions();
                }, 100);
            });

            function getUserInitials(email) {
                return email.substring(0, 2).toUpperCase();
            }
            
            // Submit button event listener
            submitButton.addEventListener('click', () => {
                finalizeResults();
            });
        </script>
    </body>
</html>
